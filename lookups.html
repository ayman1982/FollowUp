<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุงูุฌูุงุช (Lookups)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
  <header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ"></div>
        <div>
          <h1>ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ</h1>
          <div class="sub">ุฅุฏุงุฑุฉ ุฌูุงุช ุงูุชุญููู / ุฌูุงุช ุงููุงุฑุฏ ูููุง (Lookup)</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">โ</span>
        <span class="role" id="whoRole">โ</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>

  <div class="container shell">
    <aside class="sidebar">
      <div class="nav">
        <a href="incoming.html">๐ฅ ุงููุงุฑุฏ</a>
        <a href="lookups.html" class="active">๐ท๏ธ ุงูุฌูุงุช (Lookups)</a>
        <a href="followup.html">๐งพ ุงููุชุงุจุนุฉ</a>
        <a href="search.html">๐ ุงูุจุญุซ</a>
        <a href="admin.html" id="adminLink">๐ก๏ธ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</a>
      </div>
    </aside>

    <main class="main">
      <div class="card">
        <div class="hd">
          <h2>ุงูุฌูุงุช (Lookup)</h2>
          <div class="pill">ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ุงูููู ุงูุชู ุชุธูุฑ ูู Combobox ูู (ุงูุชุญููู ุฅูู) ู (ุงูุฌูุฉ ุงููุงุฑุฏ ูููุง)</div>
        </div>

        <div class="bd">
          <div class="tabs">
            <button class="tab active" id="tabTo" type="button">ุฌูุงุช ุงูุชุญููู ุฅูู</button>
            <button class="tab" id="tabFrom" type="button">ุงูุฌูุฉ ุงููุงุฑุฏ ูููุง</button>
          </div>

          <div class="grid" style="margin-top:12px;">
            <div class="field full">
              <label id="lblAdd">ุฅุถุงูุฉ ุฌูุฉ (ุงูุชุญููู ุฅูู)</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input id="newName" placeholder="ุงูุชุจ ุงุณู ุงูุฌูุฉ ุซู ุงุถุบุท ุฅุถุงูุฉ">
                <button class="btn btn-primary" id="btnAddLookup" type="button">ุฅุถุงูุฉ</button>
              </div>
              <div class="hint">ููุงุญุธุฉ: ูุฐู ุงูุตูุญุฉ ูุฎุตุตุฉ ููุฏูุฑ ุงููุธุงู ููุท.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th style="width:70px;">ู</th>
                  <th>ุงุณู ุงูุฌูุฉ</th>
                  <th style="width:260px;">ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal" id="editModal">
        <div class="panel card">
          <div class="hd">
            <h2>ุชุนุฏูู ุฌูุฉ</h2>
            <button class="btn btn-secondary" id="btnEditClose" type="button">ุฅุบูุงู</button>
          </div>
          <div class="bd">
            <div class="grid">
              <div class="field full">
                <label>ุงุณู ุงูุฌูุฉ</label>
                <input id="editName">
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" id="btnEditSave" type="button">ุญูุธ</button>
              <button class="btn btn-danger" id="btnEditDelete" type="button">ุญุฐู</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <div class="footer">ยฉ ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ - ุฅุฏุงุฑุฉ ุงูุฌูุงุช (Firebase)</div>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  qs("btnLogout")?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href="index.html";
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();

    if(me.status !== "active"){
      toast("ุงูุญุณุงุจ ููุฏ ุงููุฑุงุฌุนุฉ ุฃู ููููู.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "ูุณุชุฎุฏู";
    qs("whoRole").textContent = (me.role==="admin") ? "ูุฏูุฑ ูุธุงู" : "ูุณุชุฎุฏู";

    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";

    if(me.role !== "admin"){
      toast("ูุฐู ุงูุตูุญุฉ ูุฎุตุตุฉ ููุฏูุฑ ุงููุธุงู ููุท.");
      location.href="incoming.html";
      return;
    }

    window.__ME__ = { uid:user.uid, ...me };
    init();
  });

  // UI state
  let currentType = "to"; // 'to' | 'from'
  let editingId = null;

  const tabTo = qs("tabTo");
  const tabFrom = qs("tabFrom");
  const lblAdd = qs("lblAdd");
  const newName = qs("newName");
  const btnAddLookup = qs("btnAddLookup");
  const rowsEl = qs("rows");

  const editModal = qs("editModal");
  const btnEditClose = qs("btnEditClose");
  const btnEditSave = qs("btnEditSave");
  const btnEditDelete = qs("btnEditDelete");
  const editName = qs("editName");

  function setTab(type){
    currentType = type;
    tabTo.classList.toggle("active", type==="to");
    tabFrom.classList.toggle("active", type==="from");
    lblAdd.textContent = type==="to" ? "ุฅุถุงูุฉ ุฌูุฉ (ุงูุชุญููู ุฅูู)" : "ุฅุถุงูุฉ ุฌูุฉ (ุงูุฌูุฉ ุงููุงุฑุฏ ูููุง)";
    newName.value = "";
    load();
  }

  async function load(){
    rowsEl.innerHTML = "";
    try{
      const qy = FS.query(
        FS.collection(db,"lookups"),
        FS.where("type","==",currentType),
        FS.orderBy("name","asc"),
        FS.limit(300)
      );
      const snaps = await FS.getDocs(qy);
      const list = snaps.docs.map(d=>({id:d.id, ...d.data()})).filter(x => (x.isActive ?? true));
      rowsEl.innerHTML = list.map((x,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${esc(x.name)}</td>
          <td style="white-space:nowrap;">
            <button class="btn btn-muted" data-edit="${esc(x.id)}" type="button">ุชุนุฏูู</button>
          </td>
        </tr>
      `).join("");

      document.querySelectorAll("[data-edit]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-edit");
          const item = list.find(z=>z.id===id);
          openEdit(item);
        });
      });
    }catch(e){
      toast("ุชุนุฐุฑ ุชุญููู ุงูุฌูุงุช. ุฑุงุฌุน Firestore Rules.");
    }
  }

  function openEdit(item){
    if(!item) return;
    editingId = item.id;
    editName.value = item.name || "";
    editModal.style.display="block";
  }
  function closeEdit(){
    editModal.style.display="none";
    editingId = null;
  }

  async function addLookup(){
    const name = (newName.value||"").trim();
    if(!name){ toast("ุงูุชุจ ุงุณู ุงูุฌูุฉ ุฃููุงู."); return; }
    try{
      await FS.addDoc(FS.collection(db,"lookups"), {
        type: currentType,
        name,
        isActive: true,
        createdAt: FS.serverTimestamp(),
        updatedAt: FS.serverTimestamp()
      });
      toast("ุชูุช ุงูุฅุถุงูุฉ.", true);
      newName.value="";
      await load();
    }catch(e){
      toast("ุชุนุฐุฑ ุงูุฅุถุงูุฉ. ุฑุงุฌุน Firestore Rules.");
    }
  }

  async function saveEdit(){
    const name = (editName.value||"").trim();
    if(!editingId) return;
    if(!name){ toast("ุงุณู ุงูุฌูุฉ ูุทููุจ."); return; }
    try{
      await FS.updateDoc(FS.doc(db,"lookups",editingId), { name, updatedAt: FS.serverTimestamp() });
      toast("ุชู ุงูุญูุธ.", true);
      closeEdit();
      await load();
    }catch(e){
      toast("ุชุนุฐุฑ ุงูุญูุธ.");
    }
  }

  async function deleteEdit(){
    if(!editingId) return;
    if(!confirm("ุชุฃููุฏ ุญุฐู ุงูุฌูุฉุ")) return;
    try{
      await FS.deleteDoc(FS.doc(db,"lookups",editingId));
      toast("ุชู ุงูุญุฐู.", true);
      closeEdit();
      await load();
    }catch(e){
      toast("ุชุนุฐุฑ ุงูุญุฐู.");
    }
  }

  function init(){
    tabTo.addEventListener("click", ()=> setTab("to"));
    tabFrom.addEventListener("click", ()=> setTab("from"));
    btnAddLookup.addEventListener("click", addLookup);
    newName.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addLookup(); });

    btnEditClose.addEventListener("click", closeEdit);
    editModal.addEventListener("click", (e)=>{ if(e.target===editModal) closeEdit(); });
    btnEditSave.addEventListener("click", saveEdit);
    btnEditDelete.addEventListener("click", deleteEdit);

    setTab("to");
  }
</script>

</body>
</html>
