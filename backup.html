<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ"></div>
        <div>
          <h1>ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ</h1>
          <div class="sub">ุงูุงุฏุงุฑุฉ ุงููุฑูุฒูุฉ ูุดุฆูู ููุชุจ ุงููุฒูุฑ</div>
          <div class="sub2">ุจุฑูุงูุฌ ูุชุงุจุนุฉ ุงูุตุงุฏุฑ ูุงููุงุฑุฏ</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">โ</span>
        <span class="role" id="whoRole">โ</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html">๐ฅ ุงููุงุฑุฏ</a>
        <a href="lookups.html" id="lookupsLink">๐ท๏ธ ุงูุฌูุงุช (Lookups)</a>
        <a href="followup.html">๐งพ ุงููุชุงุจุนุฉ</a>
        <a href="search.html">๐ ุงูุจุญุซ</a>
        <a href="reports.html" id="reportsLink">๐ ุงูุชูุงุฑูุฑ</a>
        <a href="admin.html" class="active" id="adminLink">๐ก๏ธ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</a>
      </div>
    </aside>
    
<main class="main">
  <div class="card">
    <div class="card-header">
      <h2>ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</h2>
      <div class="actions">
        <button class="btn" id="btnDownload" type="button">โฌ๏ธ ุฅูุดุงุก/ุชุญููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
        <label class="btn btn-secondary" for="fileRestore" style="cursor:pointer;">โฌ๏ธ ุงุณุชุฑุฌุงุน ูุณุฎุฉ</label>
        <input id="fileRestore" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="note" style="margin-top:10px">
      <b>ููุงุญุธุฉ:</b> ูุฐู ุงูุดุงุดุฉ ูุชุงุญุฉ ููุฏูุฑ ุงููุธุงู ููุท. ุณูุชู ุฅูุดุงุก ููู JSON ูุญุชูู ุนูู ูู ุจูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงููุงุฑุฏ + ุงููุชุงุจุนุงุช + ุงูุตุงุฏุฑ + ุงูุฌูุงุช + ุงููุณุชุฎุฏููู).
      <br/>
      ุนูุฏ ุงูุงุณุชุฑุฌุงุน ุณูุชู <b>ูุณุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ</b> ุซู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.
    </div>

    <div class="hr"></div>

    <div class="grid-2" style="gap:12px">
      <div class="card" style="background:#f8fafc">
        <div style="font-weight:900; margin-bottom:6px;">ุญุงูุฉ ุงูุนูููุฉ</div>
        <div id="statusBox" style="white-space:pre-line; font-family:system-ui; font-size:14px;">ุฌุงูุฒ.</div>
      </div>
      <div class="card" style="background:#f8fafc">
        <div style="font-weight:900; margin-bottom:6px;">ุฎูุงุฑุงุช</div>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" id="chkIncludeUsers" checked />
          ุชุถููู ุจูุงูุงุช ุงููุณุชุฎุฏููู (users)
        </label>
        <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input type="checkbox" id="chkIncludeLookups" checked />
          ุชุถููู ุจูุงูุงุช ุงูุฌูุงุช (lookups)
        </label>
        <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input type="checkbox" id="chkIncludeOutgoing" checked />
          ุชุถููู ุจูุงูุงุช ุงูุตุงุฏุฑ (outgoing)
        </label>
        <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input type="checkbox" id="chkIncludeIncoming" checked />
          ุชุถููู ุจูุงูุงุช ุงููุงุฑุฏ ูุงููุชุงุจุนุงุช (incoming + followups)
        </label>
      </div>
    </div>
  </div>
</main>

  </div>
  <div class="footer">ุฌููุน ุงูุญููู ูุญููุธุฉ 2026 - ูุญุฏุฉ ุงุจุญุงุซ ูุชุทููุฑ ุชูููููุฌูุง ุงููุนูููุงุช</div>


<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const logout = qs("btnLogout");
  logout?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href = "index.html";
  });

  const statusBox = qs("statusBox");
  const btnDownload = qs("btnDownload");
  const fileRestore = qs("fileRestore");

  const chkIncludeUsers = qs("chkIncludeUsers");
  const chkIncludeLookups = qs("chkIncludeLookups");
  const chkIncludeOutgoing = qs("chkIncludeOutgoing");
  const chkIncludeIncoming = qs("chkIncludeIncoming");

  function log(msg){
    statusBox.textContent = (statusBox.textContent ? statusBox.textContent + "\n" : "") + msg;
  }

  function nowISO(){
    const d = new Date();
    const pad=n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
  }

  function downloadText(fileName, text){
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  async function getAllDocs(colName){
    const snap = await FS.getDocs(FS.collection(db, colName));
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function getIncomingWithFollowups(){
    const incomingSnap = await FS.getDocs(FS.collection(db,"incoming"));
    const incoming = [];
    for(const docu of incomingSnap.docs){
      const data = docu.data();
      const inId = docu.id;
      const fuSnap = await FS.getDocs(FS.collection(db,"incoming",inId,"followups"));
      const followups = fuSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      incoming.push({ id: inId, ...data, __followups: followups });
    }
    return incoming;
  }

  async function backup(){
    statusBox.textContent = "";
    log("ุจุฏุก ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...");

    const payload = {
      meta: { createdAt: new Date().toISOString(), app: "MIFT FollowUp", version: "backup-v1" },
      data: {}
    };

    if(chkIncludeUsers.checked){
      log("ุชุญููู users ...");
      payload.data.users = await getAllDocs("users");
      log(`ุชู ุชุญููู users: ${payload.data.users.length}`);
    }

    if(chkIncludeLookups.checked){
      log("ุชุญููู lookups ...");
      payload.data.lookups = await getAllDocs("lookups");
      log(`ุชู ุชุญููู lookups: ${payload.data.lookups.length}`);
    }

    if(chkIncludeOutgoing.checked){
      log("ุชุญููู outgoing ...");
      payload.data.outgoing = await getAllDocs("outgoing");
      log(`ุชู ุชุญููู outgoing: ${payload.data.outgoing.length}`);
    }

    if(chkIncludeIncoming.checked){
      log("ุชุญููู incoming + followups ...");
      payload.data.incoming = await getIncomingWithFollowups();
      log(`ุชู ุชุญููู incoming: ${payload.data.incoming.length}`);
      let totalFU = 0;
      for(const x of payload.data.incoming){ totalFU += (x.__followups||[]).length; }
      log(`ุฅุฌูุงูู ุงููุชุงุจุนุงุช: ${totalFU}`);
    }

    const fileName = `backup_${nowISO()}.json`;
    downloadText(fileName, JSON.stringify(payload));
    log("ุชู ุฅูุดุงุก ูุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.");
  }

  async function deleteCollection(colRef){
    const snap = await FS.getDocs(colRef);
    for(const d of snap.docs){
      await FS.deleteDoc(d.ref);
    }
  }

  async function clearIncomingAndFollowups(){
    const incomingSnap = await FS.getDocs(FS.collection(db,"incoming"));
    for(const docu of incomingSnap.docs){
      const fuRef = FS.collection(db,"incoming",docu.id,"followups");
      await deleteCollection(fuRef);
      await FS.deleteDoc(docu.ref);
    }
  }

  async function restoreFrom(payload){
    statusBox.textContent = "";
    log("ุจุฏุก ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ...");

    if(!payload || !payload.data){
      toast("ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ุตุงูุญ.");
      return;
    }

    if(!confirm("ุณูุชู ูุณุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ ุซู ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ. ูู ุฃูุช ูุชุฃูุฏุ")) return;

    // 1) Clear existing data
    try{
      if(chkIncludeIncoming.checked){
        log("ูุณุญ incoming + followups ...");
        await clearIncomingAndFollowups();
        log("ุชู ูุณุญ incoming + followups");
      }

      if(chkIncludeOutgoing.checked){
        log("ูุณุญ outgoing ...");
        await deleteCollection(FS.collection(db,"outgoing"));
        log("ุชู ูุณุญ outgoing");
      }

      if(chkIncludeLookups.checked){
        log("ูุณุญ lookups ...");
        await deleteCollection(FS.collection(db,"lookups"));
        log("ุชู ูุณุญ lookups");
      }

      if(chkIncludeUsers.checked){
        log("ูุณุญ users ...");
        await deleteCollection(FS.collection(db,"users"));
        log("ุชู ูุณุญ users");
      }
    }catch(e){
      toast("ุชุนุฐุฑ ูุณุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ. ุชุญูู ูู ุงูุตูุงุญูุงุช (Admin).");
      return;
    }

    // 2) Write data back
    try{
      if(chkIncludeUsers.checked && payload.data.users){
        log("ุงุณุชุฑุฌุงุน users ...");
        for(const u of payload.data.users){
          const id = u.id; const data = { ...u }; delete data.id;
          await FS.setDoc(FS.doc(db,"users",id), data);
        }
        log("ุชู ุงุณุชุฑุฌุงุน users");
      }

      if(chkIncludeLookups.checked && payload.data.lookups){
        log("ุงุณุชุฑุฌุงุน lookups ...");
        for(const l of payload.data.lookups){
          const id = l.id; const data = { ...l }; delete data.id;
          await FS.setDoc(FS.doc(db,"lookups",id), data);
        }
        log("ุชู ุงุณุชุฑุฌุงุน lookups");
      }

      if(chkIncludeOutgoing.checked && payload.data.outgoing){
        log("ุงุณุชุฑุฌุงุน outgoing ...");
        for(const o of payload.data.outgoing){
          const id = o.id; const data = { ...o }; delete data.id;
          await FS.setDoc(FS.doc(db,"outgoing",id), data);
        }
        log("ุชู ุงุณุชุฑุฌุงุน outgoing");
      }

      if(chkIncludeIncoming.checked && payload.data.incoming){
        log("ุงุณุชุฑุฌุงุน incoming + followups ...");
        for(const inc of payload.data.incoming){
          const id = inc.id;
          const data = { ...inc };
          const followups = data.__followups || [];
          delete data.id;
          delete data.__followups;

          await FS.setDoc(FS.doc(db,"incoming",id), data);

          for(const fu of followups){
            const fuId = fu.id;
            const fuData = { ...fu }; delete fuData.id;
            await FS.setDoc(FS.doc(db,"incoming",id,"followups",fuId), fuData);
          }
        }
        log("ุชู ุงุณุชุฑุฌุงุน incoming + followups");
      }

      toast("ุชู ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ.", true);
      log("ุงูุชูู ุงูุงุณุชุฑุฌุงุน.");
    }catch(e){
      toast("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุณุชุฑุฌุงุน. ุชุญูู ูู ุงูุตูุงุญูุงุช.");
    }
  }

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("ุงูุญุณุงุจ ููุฏ ุงููุฑุงุฌุนุฉ ุฃู ููููู.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "ูุณุชุฎุฏู";
    qs("whoRole").textContent = (me.role==="admin") ? "ูุฏูุฑ ูุธุงู" : "ูุณุชุฎุฏู";

    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";
    const lookupsLink = qs("lookupsLink");
    if(lookupsLink) lookupsLink.style.display = (me.role==="admin") ? "" : "none";
    const backupLink = qs("backupLink");
    if(backupLink) backupLink.style.display = (me.role==="admin") ? "" : "none";

    window.__ME__ = { uid: user.uid, email: user.email, role: me.role, status: me.status, name: me.name };

    // Admin only
    if(me.role !== "admin"){
      toast("ูุฐู ุงูุดุงุดุฉ ูุชุงุญุฉ ููุฏูุฑ ุงููุธุงู ููุท.");
      location.href="incoming.html";
      return;
    }

    btnDownload.addEventListener("click", backup);
    fileRestore.addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const payload = JSON.parse(text);
        await restoreFrom(payload);
      }catch(err){
        toast("ุชุนุฐุฑ ูุฑุงุกุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.");
      }finally{
        fileRestore.value = "";
      }
    });
  });
</script>



<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";

  const rows = qs("usersRows");
  const btnReload = qs("btnReloadUsers");

  function badgeRole(role){
    return role==="admin" ? '<span class="badge blue">ูุฏูุฑ ูุธุงู</span>' : '<span class="badge">ูุณุชุฎุฏู</span>';
  }
  function badgeStatus(s){
    if(s==="active") return '<span class="badge green">ููุนู</span>';
    if(s==="pending") return '<span class="badge">ูุนููู</span>';
    if(s==="disabled" || s==="blocked") return '<span class="badge red">ููููู</span>';
    return '<span class="badge red">ููููู</span>';
  }

  async function loadUsers(){
    rows.innerHTML = "";
    let docs = [];
    try{
      const qy = FS.query(FS.collection(db,"users"), FS.orderBy("createdAt","desc"), FS.limit(200));
      const snaps = await FS.getDocs(qy);
      docs = snaps.docs;
    }catch(e){
      // Fallback if createdAt missing / index / rules
      try{
        const snaps2 = await FS.getDocs(FS.collection(db,"users"));
        docs = snaps2.docs;
      }catch(e2){
        console.error(e2);
        toast("ุชุนุฐุฑ ุชุญููู ุงููุณุชุฎุฏููู (ุฑุงุฌุน Rules).");
        return;
      }
    }

    // sort client-side if needed
    docs.sort((a,b)=>{
      const da = a.data()?.createdAt?.toMillis ? a.data().createdAt.toMillis() : 0;
      const dbb = b.data()?.createdAt?.toMillis ? b.data().createdAt.toMillis() : 0;
      return dbb - da;
    });

    docs.forEach(s=>{
      const u = s.data();
      rows.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${esc(u.name||"-")}</td>
          <td>${esc(u.email||"-")}</td>
          <td>${badgeRole(u.role||"user")}</td>
          <td>${badgeStatus(u.status||"pending")}</td>
          <td style="white-space:nowrap;">
            <button class="btn btn-primary" data-act="approve" data-id="${s.id}" type="button">ูุจูู</button>
            <button class="btn btn-secondary" data-act="block" data-id="${s.id}" type="button">ุฅููุงู</button>
</td>
        </tr>
      `);
    });

    document.querySelectorAll("[data-act]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-act");
        try{
          await FS.updateDoc(FS.doc(db,"users",id), { status: act==="approve" ? "active" : "disabled" });
          toast("ุชู ุชุญุฏูุซ ุงูุญุงูุฉ.", true);
          await loadUsers();
        }catch(e){
          toast("ุชุนุฐุฑ ุงูุชุญุฏูุซ (ุฑุงุฌุน Rules).");
        }
      });
    });
  }

  btnReload.addEventListener("click", loadUsers);

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;


    const meSnap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!meSnap.exists()){ location.href="index.html"; return; }
    const me = meSnap.data();
    if(me.role!=="admin" || me.status!=="active"){
      toast("ุบูุฑ ูุตุฑุญ. ุณูุชู ุชุญูููู ูููุงุฑุฏ.");
      location.href="incoming.html";
      return;
    }
    await loadUsers();
  });
</script>

</body>
</html>