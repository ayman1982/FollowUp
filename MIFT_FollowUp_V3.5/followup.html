<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุงููุชุงุจุนุฉ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ"></div>
        <div>
          <h1>ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ</h1>
          <div class="sub">ุงูุงุฏุงุฑุฉ ุงููุฑูุฒูุฉ ูุดุฆูู ููุชุจ ุงููุฒูุฑ</div>
          <div class="sub2">ุจุฑูุงูุฌ ูุชุงุจุนุฉ ุงูุตุงุฏุฑ ูุงููุงุฑุฏ</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">โ</span>
        <span class="role" id="whoRole">โ</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html">๐ฅ ุงููุงุฑุฏ</a>
        <a href="lookups.html" id="lookupsLink">๐ท๏ธ ุงูุฌูุงุช (Lookups)</a>
        <a href="followup.html" class="active">๐งพ ุงููุชุงุจุนุฉ</a>
        <a href="search.html">๐ ุงูุจุญุซ</a>
        <a href="admin.html" id="adminLink">๐ก๏ธ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</a>
      </div>
    </aside>
    <main class="main">

<div class="card">
  <div class="hd">
    <h2>ุงููุชุงุจุนุฉ</h2>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn btn-secondary" href="incoming.html">ุฑุฌูุน ูููุงุฑุฏ</a>
      <a class="btn btn-secondary" href="search.html">ุงูุจุญุซ</a>
    </div>
  </div>
  <div class="bd">

    <div class="notice" id="noPickBanner" style="display:none; margin-bottom:12px;">
      ูู ูุชู ุงุฎุชูุงุฑ ููุถูุน ูููุชุงุจุนุฉ. ููููู ูุชุญ ุงููุชุงุจุนุฉ ูู ุฒุฑ <b>ูุชุงุจุนุฉ</b> ุฏุงุฎู ุตูุญุฉ <b>ุงููุงุฑุฏ</b>.
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-primary" href="incoming.html">ุงูุฐูุงุจ ุฅูู ุงููุงุฑุฏ</a>
      </div>
    </div>
    <div class="pills" style="margin-bottom:12px;">
      <span class="pill" id="pNumber">ุฑูู ุงููุงุฑุฏ: โ</span>
      <span class="pill" id="pFrom">ุงูุฌูุฉ: โ</span>
      <span class="pill" id="pTo">ูุญูู ุฅูู: โ</span>
    </div>

    <div class="card">
      <div class="hd"><h2 style="font-size:14px;">ุจูุงูุงุช ุงูููุถูุน</h2></div>
      <div class="bd">
        <div class="grid">
          <div class="field full">
            <label>ุงูููุถูุน</label>
            <input id="vSubject" readonly>
          </div>
          <div class="field half">
            <label>ุชุงุฑูุฎ ุงููุฑูุฏ</label>
            <input id="vDate" readonly>
          </div>
          <div class="field half">
            <label>ุงูุฑุงุณู</label>
            <input id="vSender" readonly>
          </div>
          <div class="field full">
            <label>ููุงุญุธุงุช</label>
            <textarea id="vNotes" readonly></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <div class="hd"><h2 style="font-size:14px;">ุฅุถุงูุฉ ุฅุฌุฑุงุก ูุชุงุจุนุฉ</h2></div>
      <div class="bd">
        <div class="notice" id="closedBanner" style="display:none; margin-bottom:12px;">
          ุชู ุญูุธ ุงูููุถูุน ูุฅุบูุงู ุงููุชุงุจุนุฉ. ููููู ุงุณุชุนุฑุงุถ ุฎุทูุงุช ุงููุชุงุจุนุฉ ููุท.
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-muted" id="btnReopen" type="button" style="display:none;">ูุชุญ ูููุชุงุจุนุฉ</button>
          </div>
        </div>
        <div class="grid">
          <div class="field half">
            <label>ููุน ุงูุฅุฌุฑุงุก</label>
            <select id="fType">
              <option>ุฑุฏ ุจุฎุทุงุจ</option>
              <option>ุชุญููู</option>
              <option>ุชุฐููุฑ</option>
              <option>ุฅุนุงุฏุฉ ุชูุฌูู</option>
              <option>ุญูุธ</option>
              <option>ุฅุญุงุทุฉ</option>
            </select>
          </div>
          <div class="field half">
            <label>ููุฌู ุฅูู / ุฌูุฉ ุงูุชุญููู</label>
            <select id="fTo"></select>
          </div>
          <div class="field half" id="remDaysField" style="display:none;">
            <label>ุนุฏุฏ ุงูุฃูุงู</label>
            <input id="fRemDays" type="number" min="1" placeholder="ูุซุงู: 5">
          </div>
          <div class="field full">
            <label>ุชูุงุตูู ุงูุฅุฌุฑุงุก</label>
            <textarea id="fDetails" placeholder="ุชูุงุตูู ุงููุชุงุจุนุฉ..."></textarea>
          </div>
          <div class="field full">
            <button class="btn btn-primary" id="btnAddFollow" type="button">ุญูุธ ุงูุฅุฌุฑุงุก</button>
          </div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <div class="hd">
        <h2 style="font-size:14px;">ุณุฌู ุงููุชุงุจุนุฉ</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-muted" type="button" id="btnToggleOutgoing">๐ค ุงูุตุงุฏุฑ ุงููุฑุชุจุท</button>
        </div>
      </div>
      <div class="bd">
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ/ุงูููุช</th>
                <th>ุงูุฅุฌุฑุงุก</th>
                <th>ุงูุชูุงุตูู</th>
                <th>ููุฌู ุฅูู</th>
                <th>ุจูุงุณุทุฉ</th>
              </tr>
            </thead>
            <tbody id="fRows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="card" id="outgoingCard" style="display:none;">
      <div class="hd">
        <h2 style="font-size:14px;">ุงูุตุงุฏุฑ ุงููุฑุชุจุท</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-muted" type="button" id="btnRefreshOutgoing">โบ ุชุญุฏูุซ</button>
        </div>
      </div>
      <div class="bd">
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>ุฑูู ุงูุตุงุฏุฑ</th>
                <th>ุชุงุฑูุฎ ุงูุชุตุฏูุฑ</th>
                <th>ุงูุชุญููู ุฅูู</th>
                <th>ุงูููุถูุน</th>
                <th>ุงููุฑุณู ุฅููู</th>
                <th>ููุงุญุธุงุช</th>
              </tr>
            </thead>
            <tbody id="oRows"></tbody>
          </table>
        </div>
      </div>
    </div>


  </div>
</div>

    </main>
  </div>
  <div class="footer">ุฌููุน ุงูุญููู ูุญููุธุฉ 2026 - ูุญุฏุฉ ุงุจุญุงุซ ูุชุทููุฑ ุชูููููุฌูุง ุงููุนูููุงุช</div>
<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const logout = qs("btnLogout");
  logout?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href = "index.html";
  });



  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("ุงูุญุณุงุจ ููุฏ ุงููุฑุงุฌุนุฉ ุฃู ููููู.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "ูุณุชุฎุฏู";
    qs("whoRole").textContent = (me.role==="admin") ? "ูุฏูุฑ ูุธุงู" : "ูุณุชุฎุฏู";
    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";
    const lookupsLink = qs("lookupsLink");
    if(lookupsLink) lookupsLink.style.display = (me.role==="admin") ? "" : "none";
    window.__ME__ = { uid: user.uid, ...me };
  });
</script>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";
  import { fillSelectWithLookups } from "./assets/lookups.js";

  const incomingId = sessionStorage.getItem("selectedIncomingId") || new URL(location.href).searchParams.get("id");

  const fTypeEl = qs("fType");
  const fToEl = qs("fTo");
  const fDetailsEl = qs("fDetails");
  const remDaysField = qs("remDaysField");
  const fRemDaysEl = qs("fRemDays");
  const btnAddFollow = qs("btnAddFollow");
  const closedBanner = qs("closedBanner");
  const btnReopen = qs("btnReopen");

  let incomingData = null;
  let isClosed = false;


  async function loadToLookupOptions(){
    try{
      await fillSelectWithLookups(qs("fTo"), "to", { includeDash:true });
    }catch(e){
      // ูู ุงูุตูุงุญูุงุช/ุงููุณุงุฑ ุบูุฑ ูุชุงุญุ ูุชุฑููุง ูุงุฑุบุฉ
    }
  }

  function normalizeToValue(v){
    const x = (v ?? "").toString().trim();
    return (x === "โ") ? "" : x;
  }

  function ymd(d){
    try{
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }catch{ return ""; }
  }

  function setFormEnabled(enabled){
    if(fTypeEl) fTypeEl.disabled = !enabled;
    if(fToEl) fToEl.disabled = !enabled;
    if(fDetailsEl) fDetailsEl.disabled = !enabled;
    if(fRemDaysEl) fRemDaysEl.disabled = !enabled;
    if(btnAddFollow) btnAddFollow.disabled = !enabled;
  }

  function applyTypeBehavior(){
    if(!fTypeEl) return;
    const t = fTypeEl.value;
    // ุงูุชุฑุงุถููุง: ุงููู ูุชุงุญ
    if(fToEl){
      fToEl.disabled = false;
    }

    // ุญูู ุนุฏุฏ ุงูุฃูุงู ูุธูุฑ ููุท ุนูุฏ "ุชุฐููุฑ"
    if(remDaysField){
      remDaysField.style.display = (t === "ุชุฐููุฑ") ? "" : "none";
    }
    if(fRemDaysEl && t !== "ุชุฐููุฑ"){
      fRemDaysEl.value = "";
    }

    // "ุฅุญุงุทุฉ" ู "ุญูุธ" ูุง ูุญุชุงุฌุงู ุฌูุฉ ุชุญููู
    if(t === "ุฅุญุงุทุฉ" || t === "ุญูุธ"){
      if(fToEl){
        fToEl.value = "โ";
        fToEl.disabled = true;
      }
    }

    // ุนูุฏ ุฅุบูุงู ุงูููุถูุน (ุญูุธ) ูุง ููุณูุญ ุจุฅุถุงูุฉ ุฅุฌุฑุงุกุงุช ุฅูุง ููุฃุฏูู ุจุนุฏ ูุชุญู
    if(isClosed){
      setFormEnabled(false);
    }
  }

  // ูุชุญ ุงูููุถูุน ูููุชุงุจุนุฉ (ููุฃุฏูู ููุท)
  if(btnReopen){
    btnReopen.addEventListener("click", async ()=>{
      const me = window.__ME__ || {};
      if(me.role !== "admin") return;
      if(!incomingId) return;
      try{
        await FS.updateDoc(FS.doc(db,"incoming",incomingId),{
          isClosed: false,
          reopenedAt: FS.serverTimestamp(),
          reopenedByUid: me.uid || null,
          reopenedByName: me.name || me.email || "ูุฏูุฑ ูุธุงู"
        });
        toast("ุชู ูุชุญ ุงูููุถูุน ูููุชุงุจุนุฉ.", true);
        await loadIncoming();
      }catch(e){
        toast("ุชุนุฐุฑ ูุชุญ ุงูููุถูุน. ุชุญูู ูู Rules.");
      }
    });
  }

  // ุชูุงุนู ููุน ุงูุฅุฌุฑุงุก
  if(fTypeEl){
    fTypeEl.addEventListener("change", ()=>{
      applyTypeBehavior();
    });
  }

  // Populate combobox after auth is ready
  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(user) await loadToLookupOptions();
  });
  const fRows = qs("fRows");

  const oCard = qs("outgoingCard");
  const oRows = qs("oRows");
  let outgoingLoaded = false;

  async function loadOutgoing(){
    if(!incomingId){ return; }
    if(oRows) oRows.innerHTML = "";
    try{
      const q = FS.query(
        FS.collection(db, "outgoing"),
        FS.where("incomingId", "==", incomingId),
        FS.limit(200)
      );
      const snap = await FS.getDocs(q);
      const items = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        items.push({ id: d.id, ...x });
      });

      items.sort((a,b)=> String(b.exportDate||"").localeCompare(String(a.exportDate||"")));

      if(!items.length){
        if(oRows){
          oRows.innerHTML = `<tr><td colspan="6" style="text-align:center; opacity:.7;">ูุง ููุฌุฏ ุตุงุฏุฑ ูุฑุชุจุท ุจูุฐุง ุงููุงุฑุฏ.</td></tr>`;
        }
        outgoingLoaded = true;
        return;
      }

      if(oRows){
        oRows.innerHTML = items.map(x=>`
          <tr>
            <td>${esc(x.number || "")}</td>
            <td>${esc(x.exportDate || "")}</td>
            <td>${esc(x.to || "")}</td>
            <td>${esc(x.subject || "")}</td>
            <td>${esc(x.recipient || "")}</td>
            <td>${esc(x.notes || "")}</td>
          </tr>
        `).join("");
      }
      outgoingLoaded = true;
    }catch(e){
      toast("ุชุนุฐุฑ ุชุญููู ุงูุตุงุฏุฑ ุงููุฑุชุจุท. ุชุญูู ูู ุงูุตูุงุญูุงุช.", false);
    }
  }



  // ุงูุตุงุฏุฑ ุงููุฑุชุจุท (ุนุฑุถ/ุฅุฎูุงุก)
  const btnToggleOutgoing = qs("btnToggleOutgoing");
  const btnRefreshOutgoing = qs("btnRefreshOutgoing");

  if(btnToggleOutgoing){
    btnToggleOutgoing.addEventListener("click", async ()=>{
      if(!oCard) return;
      const willShow = (oCard.style.display === "none" || !oCard.style.display);
      oCard.style.display = willShow ? "block" : "none";
      if(willShow && !outgoingLoaded){
        await loadOutgoing();
      }
    });
  }

  if(btnRefreshOutgoing){
    btnRefreshOutgoing.addEventListener("click", async ()=>{
      outgoingLoaded = false;
      await loadOutgoing();
    });
  }

  async function loadIncoming(){
    if(!incomingId){
      const b = qs("noPickBanner");
      if(b) b.style.display = "block";
      toast("ุงุฎุชุฑ ููุถูุน ูู ุตูุญุฉ ุงููุงุฑุฏ ุฃููุงู.");
      return;
    }
    const snap = await FS.getDoc(FS.doc(db,"incoming",incomingId));
    if(!snap.exists()){
      const b = qs("noPickBanner");
      if(b) b.style.display = "block";
      toast("ุงูููุถูุน ุบูุฑ ููุฌูุฏ.");
      return;
    }
    const x = snap.data();
    incomingData = x;
    isClosed = (x && x.isClosed === true);

    // ุญุงูุฉ ุงูุฅุบูุงู (ุญูุธ)
    if(closedBanner){
      closedBanner.style.display = isClosed ? "block" : "none";
    }
    const me = window.__ME__ || {};
    const canReopen = (me.role === "admin");
    if(btnReopen){
      btnReopen.style.display = (isClosed && canReopen) ? "" : "none";
    }

    if(isClosed){
      // ููุน ุงูุฅุถุงูุฉ ููุฌููุน (ูููุชุญ ููุท ุจูุงุณุทุฉ ุงูุฃุฏูู)
      setFormEnabled(false);
    }else{
      setFormEnabled(true);
    }

    applyTypeBehavior();
    qs("pNumber").textContent = "ุฑูู ุงููุงุฑุฏ: " + (x.number || "โ");
    qs("pFrom").textContent = "ุงูุฌูุฉ: " + (x.fromOrg || "โ");
    qs("pTo").textContent = "ูุญูู ุฅูู: " + (x.to || "โ");

    qs("vSubject").value = x.subject || "";
    qs("vDate").value = x.date || "";
    qs("vSender").value = x.sender || "";
    qs("vNotes").value = x.notes || "";
  }

  function tsToText(ts){
    try{
      if(!ts) return "";
      if(typeof ts === "string") return ts;
      if(ts.toDate) return ts.toDate().toLocaleString("ar-EG");
      return "";
    }catch{ return ""; }
  }

  async function loadFollowups(){
    const qy = FS.query(FS.collection(db,"incoming",incomingId,"followups"), FS.orderBy("ts","desc"), FS.limit(200));
    const snaps = await FS.getDocs(qy);
    const list = snaps.docs.map(d=>({id:d.id, ...d.data()}));
    fRows.innerHTML = list.map(a=>`
      <tr>
        <td>${esc(tsToText(a.ts))}</td>
        <td><span class="badge blue">${esc(a.type||"")}</span></td>
        <td>${esc(a.details||"")}</td>
        <td>${esc(a.to||"")}</td>
        <td>${esc(a.byName||"")}</td>
      </tr>
    `).join("");
  }

  btnAddFollow?.addEventListener("click", async ()=>{
    const me = window.__ME__ || {};
    if(isClosed){
      toast("ุชู ุญูุธ ุงูููุถูุน ูุฅุบูุงู ุงููุชุงุจุนุฉ. ูุง ูููู ุฅุถุงูุฉ ุฅุฌุฑุงุกุงุช ุฅูุง ุจุนุฏ ูุชุญ ุงูููุถูุน ุจูุงุณุทุฉ ูุฏูุฑ ุงููุธุงู.");
      return;
    }

    const type = (fTypeEl?.value || "").trim();
    if(type === "ุฑุฏ ุจุฎุทุงุจ"){
      // ูุชุญ ุดุงุดุฉ ุฅุถุงูุฉ ุตุงุฏุฑ ูุฑุชุจุทุฉ ุจุงููุงุฑุฏ ุงูุญุงูู
      sessionStorage.setItem("selectedIncomingId", incomingId);
      window.location.href = `outgoing_add.html?id=${encodeURIComponent(incomingId)}`;
      return;
    }

    const to = normalizeToValue(fToEl?.value);
    const details = (fDetailsEl?.value || "").trim();

    // ุชุฐููุฑ: ุฅุฏุฎุงู ุนุฏุฏ ุฃูุงู ูุญุณุงุจ ุชุงุฑูุฎ ุงูุชุฐููุฑ
    let reminderDays = null;
    let reminderDue = "";
    if(type === "ุชุฐููุฑ"){
      const v = (fRemDaysEl?.value || "").toString().trim();
      const n = Number(v);
      if(!v || !Number.isFinite(n) || n <= 0){
        toast("ูุฑุฌู ุฅุฏุฎุงู ุนุฏุฏ ุงูุฃูุงู ููุชุฐููุฑ.");
        return;
      }
      reminderDays = Math.floor(n);
      const base = new Date();
      const due = new Date(base.getFullYear(), base.getMonth(), base.getDate() + reminderDays);
      reminderDue = ymd(due);
    }

    if(!details){
      toast("ูุฑุฌู ุฅุฏุฎุงู ุชูุงุตูู ุงูุฅุฌุฑุงุก.");
      return;
    }

    // ููุงุนุฏ ุญุณุจ ููุน ุงูุฅุฌุฑุงุก
    if(type === "ุฅุนุงุฏุฉ ุชูุฌูู" && !to){
      toast("ูุฑุฌู ุงุฎุชูุงุฑ ุฌูุฉ ูู (ููุฌู ุฅูู / ุฌูุฉ ุงูุชุญููู).");
      return;
    }

    // "ุฅุญุงุทุฉ" ูุง ุชุณุชุฎุฏู ุฌูุฉ ุชุญููู
    const finalTo = (type === "ุฅุญุงุทุฉ" || type === "ุญูุธ") ? "" : to;

    try{
      // ุฅุถุงูุฉ ุณุฌู ุงููุชุงุจุนุฉ
      await FS.addDoc(FS.collection(db,"incoming",incomingId,"followups"),{
        type,
        to: finalTo,
        details,
        reminderDays: reminderDays ?? null,
        reminderDue: reminderDue || "",
        byUid: me.uid || null,
        byName: me.name || me.email || "ูุณุชุฎุฏู",
        ts: FS.serverTimestamp()
      });

      // ุนูุฏ ุชุณุฌูู "ุชุฐููุฑ" ูุชู ุญูุธ ุชุงุฑูุฎ ุงูุชุฐููุฑ ุนูู ุงููุงุฑุฏ ูุณูููุฉ ุฅุธูุงุฑู ูู ุดุงุดุฉ ุงููุงุฑุฏ
      if(type === "ุชุฐููุฑ" && reminderDue){
        await FS.updateDoc(FS.doc(db,"incoming",incomingId),{
          reminderDue,
          reminderDays: reminderDays ?? null,
          reminderSetAt: FS.serverTimestamp(),
          reminderSetByUid: me.uid || null,
          reminderSetByName: me.name || me.email || "ูุณุชุฎุฏู"
        });
      }

      // "ุญูุธ" => ุฅุบูุงู ุงููุชุงุจุนุฉ ุนูู ุงูููุถูุน
      if(type === "ุญูุธ"){
        await FS.updateDoc(FS.doc(db,"incoming",incomingId),{
          isClosed: true,
          closedAt: FS.serverTimestamp(),
          closedByUid: me.uid || null,
          closedByName: me.name || me.email || "ูุณุชุฎุฏู"
        });
      }

      if(fDetailsEl) fDetailsEl.value = "";
      if(fRemDaysEl) fRemDaysEl.value = "";
      toast("ุชูุช ุฅุถุงูุฉ ุงููุชุงุจุนุฉ.", true);
      await loadFollowups();
      await loadIncoming();
    }catch(e){
      toast("ุชุนุฐุฑ ุฅุถุงูุฉ ุงููุชุงุจุนุฉ. ุชุญูู ูู Rules.");
    }
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    setTimeout(async ()=>{
      await loadIncoming();
      await loadFollowups();
    }, 500);
  });
</script>

</body>
</html>
