<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø§Ù„ÙˆØ§Ø±Ø¯</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©"></div>
        <div>
          <h1>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</h1>
          <div class="sub">Ø§Ù„Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ø´Ø¦ÙˆÙ† Ù…ÙƒØªØ¨ Ø§Ù„ÙˆØ²ÙŠØ±</div>
          <div class="sub2">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ§Ø¯Ø± ÙˆØ§Ù„ÙˆØ§Ø±Ø¯</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">â€”</span>
        <span class="role" id="whoRole">â€”</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html" class="active">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</a>
        <a href="lookups.html" id="lookupsLink">ğŸ·ï¸ Ø§Ù„Ø¬Ù‡Ø§Øª (Lookups)</a>
        <a href="followup.html">ğŸ§¾ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</a>
        <a href="search.html">ğŸ” Ø§Ù„Ø¨Ø­Ø«</a>
        <a href="reports.html" id="reportsLink">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        <a href="admin.html" id="adminLink">ğŸ›¡ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
        <a href="backup.html" id="backupLink">ğŸ—„ï¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</a>
      </div>
    </aside>
    <main class="main">

      <div class="kpis">
        <div class="kpi"><div class="n" id="kTotal">0</div><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯</div></div>
        <div class="kpi"><div class="n" id="kThisWeek">0</div><div class="t">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…</div></div>
        <div class="kpi"><div class="n" id="kToLegal">0</div><div class="t" id="kTopDeptTitle">Ø£ÙƒØ«Ø± Ø¥Ø¯Ø§Ø±Ø©: â€”</div></div>
        
        <div class="kpi"><div class="n" id="kReminders">â€”</div><div class="t">ØªØ°ÙƒÙŠØ± Ù…Ø³Ø¬Ù„</div></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Ø§Ù„ÙˆØ§Ø±Ø¯</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-muted" type="button" id="btnRefresh">â†º ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn btn-primary" type="button" id="btnAdd">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø±Ø¯</button>
            <button class="btn btn-muted" type="button" id="btnImportExcel">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§ÙƒØ³Ù„</button>
            <input id="excelFile" type="file" accept=".xlsx,.xls" style="display:none" />
          </div>
        </div>

        <div class="bd">
          <div class="grid">
            <div class="field full">
              <label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
              <input id="q" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ / Ø§Ù„Ø¬Ù‡Ø© / Ø§Ù„Ø±Ø§Ø³Ù„ / Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰">
            </div>
          </div>

          <div class="tablewrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯</th>
                  <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                  <th>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§</th>
                  <th>Ø§Ù„Ø±Ø§Ø³Ù„</th>
                  <th>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal" id="modal">
        <div class="panel card">
          <div class="hd">
            <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ø±Ø¯</h2>
            <button class="btn btn-secondary" id="btnClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
          <div class="bd">
            <div class="grid">
              <div class="field">
                <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯</label>
                <input id="fNumber" placeholder="332301">
              </div>
              <div class="field">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯</label>
                <input id="fDate" type="date">
              </div>
              <div class="field">
                <label>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰</label>
                <select id="fTo">
                  <option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</option>
                  <option>Ù…ÙƒØªØ¨ Ù…Ø¹Ø§Ù„ÙŠ Ø§Ù„ÙˆØ²ÙŠØ±</option>
                  <option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ†ÙŠØ©</option>
                  <option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</option>
                  <option>â€”</option>
                </select>
              </div>
              <div class="field full">
                <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                <input id="fSubject" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹">
              </div>
              <div class="field">
                <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§</label>
                <select id="fFrom"></select>
              </div>
              <div class="field">
                <label>Ø§Ù„Ø±Ø§Ø³Ù„</label>
                <input id="fSender" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±Ø§Ø³Ù„">
              </div>
              <div class="field full">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="fNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" id="btnSave" type="button">Ø­ÙØ¸</button>
              <button class="btn btn-danger" id="btnDelete" type="button" style="display:none;">Ø­Ø°Ù</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
  <div class="footer">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2026 - ÙˆØ­Ø¯Ø© Ø§Ø¨Ø­Ø§Ø« ÙˆØªØ·ÙˆÙŠØ± ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const logout = qs("btnLogout");
  logout?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href = "index.html";
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ùˆ Ù…ÙˆÙ‚ÙˆÙ.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "Ù…Ø³ØªØ®Ø¯Ù…";
    qs("whoRole").textContent = (me.role==="admin") ? "Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…" : "Ù…Ø³ØªØ®Ø¯Ù…";
    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";
    const lookupsLink = qs("lookupsLink");
    if(lookupsLink) lookupsLink.style.display = (me.role==="admin") ? "" : "none";
    const backupLink = qs("backupLink");
    if(backupLink) backupLink.style.display = (me.role==="admin") ? "" : "none";
    window.__ME__ = { uid: user.uid, ...me };
  });
</script>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";
  import { fillSelectWithLookups } from "./assets/lookups.js";

  const rowsEl = qs("rows");
  const qEl = qs("q");
  const btnAdd = qs("btnAdd");
  const btnRefresh = qs("btnRefresh");
  const btnImportExcel = qs("btnImportExcel");
  const excelFile = qs("excelFile");

  const modal = qs("modal");
  const modalTitle = qs("modalTitle");
  const btnClose = qs("btnClose");
  const btnSave = qs("btnSave");
  const btnDelete = qs("btnDelete");

  const fNumber = qs("fNumber");
  const fDate = qs("fDate");
  const fSubject = qs("fSubject");
  const fFrom = qs("fFrom");
  const fSender = qs("fSender");
  const fTo = qs("fTo");
  const fNotes = qs("fNotes");

  let all = [];
  let editingId = null;

  async function loadLookupOptions(){
    try{
      await fillSelectWithLookups(fTo, "to", { includeDash:true });
      await fillSelectWithLookups(fFrom, "from", { includeDash:false });
    }catch(e){
      // ignore if rules deny
    }
  }


  async function openModal(item){
    modal.style.display = "block";
    await loadLookupOptions();
    if(item){
      editingId = item.id;
      modalTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ø±Ø¯";
      fNumber.value = item.number || "";
      fDate.value = item.date || "";
      fSubject.value = item.subject || "";
      fFrom.value = item.fromOrg || "";
      fSender.value = item.sender || "";
      fTo.value = item.to || "â€”";
      fNotes.value = item.notes || "";
      btnDelete.style.display = (window.__ME__?.role==="admin") ? "" : "none";
    }else{
      editingId = null;
      modalTitle.textContent = "Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø±Ø¯";
      fNumber.value = "";
      fDate.value = "";
      fSubject.value = "";
      fFrom.value = "";
      fSender.value = "";
      fTo.value = "â€”";
      fNotes.value = "";
      btnDelete.style.display = "none";
    }
  }
  function closeModal(){ modal.style.display = "none"; }

  function computeKPIs(list){
    qs("kTotal").textContent = list.length;
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
    const todayStr = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;
    function asDate(v){
      if(!v) return null;
      try{
        if (typeof v.toDate === "function") return v.toDate();
        if (v instanceof Date) return v;
        if (typeof v === "object" && typeof v.seconds === "number") return new Date(v.seconds*1000);
        if (typeof v === "string" && v) return new Date(v);
      }catch(e){}
      return null;
    }
    const todayCount = list.filter(x => {
      const cd = asDate(x.createdAt) || (x.date ? new Date(x.date) : null);
      if(!cd || isNaN(cd.getTime())) return false;
      return cd >= start && cd < end;
    }).length;
    qs("kThisWeek").textContent = todayCount;
    // Ø£ÙƒØ«Ø± Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø§ ÙˆØ§Ø±Ø¯ (Ø­Ø³Ø¨ Ø­Ù‚Ù„ "Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰")
    (function(){
      const counts = {};
      list.forEach(x=>{
        const k = (x.to||"").toString().trim();
        if(!k || k==="â€”") return;
        counts[k] = (counts[k]||0)+1;
      });
      let topName = "â€”";
      let topCount = 0;
      Object.keys(counts).forEach(k=>{
        const c = counts[k];
        if(c > topCount){
          topCount = c;
          topName = k;
        }
      });
      qs("kToLegal").textContent = topCount;
      const t = qs("kTopDeptTitle");
      if(t) t.textContent = `Ø£ÙƒØ«Ø± Ø¥Ø¯Ø§Ø±Ø©: ${topName}`;
    })();
// ØªØ°ÙƒÙŠØ± Ù…Ø³Ø¬Ù„ (ÙŠØ¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ØªÙŠ Ø­Ø§Ù† Ù…ÙˆØ¹Ø¯ ØªØ°ÙƒÙŠØ±Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ…)
    (function(){
      const due = list.filter(x=>{
        if(x.isClosed) return false;
        const d = (x.reminderDue||"").toString().trim();
        return !!d && d === todayStr;
      }).map(x=>x.number).filter(Boolean);

      const el = qs("kReminders");
      if(!el) return;
      if(!due.length){
        el.textContent = "â€”";
        return;
      }
      // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ¨Ø¬Ø§Ù†Ø¨Ù‡ ÙƒÙ„Ù…Ø© "ØªØ°ÙƒÙŠØ±" (Ø³Ø·Ø± Ù„ÙƒÙ„ ÙˆØ§Ø±Ø¯)
      el.innerHTML = due.slice(0,10).map(n=>`${esc(n)} ØªØ°ÙƒÙŠØ±`).join("<br>");
    })();
  }

  function render(){
    const q = (qEl.value||"").trim().toLowerCase();
    const list = q ? all.filter(x =>
      [x.number,x.date,x.subject,x.fromOrg,x.sender,x.to,x.notes].some(v => (v||"").toString().toLowerCase().includes(q))
    ) : all;

    computeKPIs(all);

    rowsEl.innerHTML = list.map(x=>`
      <tr>
        <td><b>${esc(x.number)}</b></td>
        <td>${esc(x.date)}</td>
        <td>${esc(x.subject)}${x.isClosed ? ` <span class="pill">Ù…ØºÙ„Ù‚</span>` : ``}</td>
        <td>${esc(x.fromOrg)}</td>
        <td>${esc(x.sender)}</td>
        <td>${esc(x.to)}</td>
        <td>${esc(x.notes)}</td>
        <td style="white-space:nowrap;">
          <button class="btn btn-muted" data-edit="${esc(x.id)}" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-secondary" data-follow="${esc(x.id)}" type="button">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </td>
      </tr>
    `).join("");

    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const item = all.find(z=>z.id===id);
        openModal(item);
      });
    });
    document.querySelectorAll("[data-follow]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-follow");
        sessionStorage.setItem("selectedIncomingId", id);
        location.href = "followup.html";
      });
    });
  }

  async function loadIncoming(){
    const qy = FS.query(FS.collection(db,"incoming"), FS.orderBy("createdAt","desc"), FS.limit(200));
    const snaps = await FS.getDocs(qy);
    all = snaps.docs.map(d => ({ id:d.id, ...d.data() }));
    render();
  }

  btnAdd.addEventListener("click", ()=> openModal(null));
  btnClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
  btnRefresh.addEventListener("click", loadIncoming);
  qEl.addEventListener("input", render);


  // ===== Excel Import (Incoming) =====
  function normKey(s){
    return (s||"").toString().trim().toLowerCase()
      .replace(/\s+/g," ")
      .replace(/[Ù€]/g,"")
      .replace(/[Ø£Ø¥Ø¢]/g,"Ø§")
      .replace(/[Ù‰]/g,"ÙŠ");
  }

  const COL_MAP = new Map([
    // number
    ["number","number"], ["incoming number","number"], ["Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯","number"], ["Ø±Ù‚Ù… ÙˆØ§Ø±Ø¯","number"], ["Ø±Ù‚Ù…","number"],
    // date
    ["date","date"], ["incoming date","date"], ["ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯","date"], ["ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ§Ø±Ø¯","date"], ["Ø§Ù„ØªØ§Ø±ÙŠØ®","date"],
    // subject
    ["subject","subject"], ["Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","subject"], ["Ø¹Ù†ÙˆØ§Ù†","subject"],
    // from
    ["fromorg","fromOrg"], ["from org","fromOrg"], ["from","fromOrg"], ["Ø§Ù„Ø¬Ù‡Ø©","fromOrg"], ["Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§","fromOrg"], ["ÙˆØ§Ø±Ø¯ Ù…Ù†","fromOrg"],
    // sender
    ["sender","sender"], ["Ø§Ù„Ø±Ø§Ø³Ù„","sender"], ["Ø§Ù„Ù…Ø±Ø³Ù„","sender"],
    // to
    ["to","to"], ["forward to","to"], ["ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙŠ","to"], ["Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‰","to"], ["Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰","to"], ["Ù…Ø­ÙˆÙ„ Ø§Ù„Ù‰","to"], ["Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰","to"],
    // notes
    ["notes","notes"], ["Ù…Ù„Ø§Ø­Ø¸Ø§Øª","notes"], ["Ù…Ù„Ø§Ø­Ø¸Ø©","notes"], ["ØªÙØ§ØµÙŠÙ„","notes"],
  ]);

  function excelDateToYMD(v){
    if(v==null || v==="") return "";
    // if already looks like yyyy-mm-dd
    const s = v.toString().trim();
    if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)) return s;
    // dd/mm/yyyy or dd-mm-yyyy
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(m){
      const dd = m[1].padStart(2,"0");
      const mm = m[2].padStart(2,"0");
      return `${m[3]}-${mm}-${dd}`;
    }
    // Excel serial date (number)
    if(typeof v === "number" && window.XLSX?.SSF?.parse_date_code){
      const d = XLSX.SSF.parse_date_code(v);
      if(d && d.y && d.m && d.d){
        const mm = String(d.m).padStart(2,"0");
        const dd = String(d.d).padStart(2,"0");
        return `${d.y}-${mm}-${dd}`;
      }
    }
    return ""; // unknown
  }

  function toRowObject(headers, row){
    const obj = {};
    headers.forEach((h, idx)=>{
      const key = COL_MAP.get(normKey(h));
      if(!key) return;
      if(key === "date"){ obj[key] = (row[idx] ?? ""); } else { obj[key] = (row[idx] ?? "").toString().trim(); }
    });
    // normalize
    if(obj.number) obj.number = obj.number.toString().trim();
    if(obj.subject) obj.subject = obj.subject.toString().trim();
    if(obj.fromOrg) obj.fromOrg = obj.fromOrg.toString().trim();
    if(obj.sender) obj.sender = obj.sender.toString().trim();
    if(obj.to) obj.to = obj.to.toString().trim() || "â€”";
    if(obj.notes) obj.notes = obj.notes.toString().trim();
    if(obj.date) obj.date = excelDateToYMD(obj.date);
    return obj;
  }

  async function getExistingNumbers(nums){
    const existing = new Set();
    const unique = Array.from(new Set(nums.filter(Boolean)));
    // Firestore "in" supports up to 30 values
    const chunkSize = 30;
    for(let i=0;i<unique.length;i+=chunkSize){
      const chunk = unique.slice(i,i+chunkSize);
      const qy = FS.query(FS.collection(db,"incoming"), FS.where("number","in",chunk));
      const snaps = await FS.getDocs(qy);
      snaps.forEach(d=>{
        const n = (d.data()?.number||"").toString().trim();
        if(n) existing.add(n);
      });
    }
    return existing;
  }

  async function importIncomingFromExcel(file){
    if(!file) return;
    if(!window.XLSX){
      toast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
      return;
    }

    const buf = await file.arrayBuffer();
    let wb;
    try{
      wb = XLSX.read(buf, { type:"array" });
    }catch(e){
      toast("Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ØºÙŠØ± ØµØ§Ù„Ø­.");
      return;
    }

    const sheetName = wb.SheetNames?.[0];
    if(!sheetName){
      toast("Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ÙØ§Ø±Øº.");
      return;
    }
    const ws = wb.Sheets[sheetName];

    // Read as array of arrays (first row headers)
    const aoa = XLSX.utils.sheet_to_json(ws, { header:1, blankrows:false, defval:"" });
    if(!aoa || aoa.length < 2){
      toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø«Ù… Ø¨ÙŠØ§Ù†Ø§Øª).");
      return;
    }

    const headers = aoa[0].map(h=> (h||"").toString().trim());
    const rows = aoa.slice(1).filter(r => r && r.some(c => (c??"").toString().trim()!==""));

    // Build row objects
    const items = rows.map(r => toRowObject(headers, r)).filter(x => x.number);

    if(items.length === 0){
      toast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ (Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯).");
      return;
    }

    // Validate required fields
    const bad = items.filter(x => !x.number || !x.date || !x.subject);
    if(bad.length){
      toast(`ÙŠÙˆØ¬Ø¯ ${bad.length} ØµÙ/ØµÙÙˆÙ Ù†Ø§Ù‚ØµØ© (Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ / ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹). ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.`);
      return;
    }

    // Check duplicates inside file
    const seen = new Set();
    const dupInFile = new Set();
    items.forEach(x=>{
      const n = x.number.trim();
      if(seen.has(n)) dupInFile.add(n);
      seen.add(n);
    });
    if(dupInFile.size){
      toast(`ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ø±Ù‚Ù…/Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ø±Ø¯: ${Array.from(dupInFile).slice(0,5).join(" ØŒ ")}. ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.`);
      return;
    }

    // Check duplicates against Firestore + current loaded list
    const currentNumbers = new Set((all||[]).map(x => (x.number||"").toString().trim()).filter(Boolean));
    const nums = items.map(x=>x.number.trim());
    const existingInDb = await getExistingNumbers(nums);
    const duplicates = nums.filter(n => currentNumbers.has(n) || existingInDb.has(n));

    // Skip duplicates, import the rest
    const dupSet = new Set(duplicates);
    const toImport = items.filter(x => !dupSet.has(x.number.trim()));

    if(toImport.length === 0){
      toast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù…Ù„Ù Ù…ÙƒØ±Ø±Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
      return;
    }

    // Confirm if a lot of records
    if(toImport.length > 200 && !confirm(`Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${toImport.length} ÙˆØ§Ø±Ø¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)){
      return;
    }

    // Write docs (sequential to avoid rate limits)
    const me = window.__ME__ || {};
    let ok=0, fail=0;
    for(const x of toImport){
      const base = {
        number: x.number.trim(),
        date: x.date,
        subject: x.subject,
        fromOrg: x.fromOrg || "",
        sender: x.sender || "",
        to: x.to || "â€”",
        notes: x.notes || "",
        createdAt: FS.serverTimestamp(),
        updatedAt: FS.serverTimestamp(),
        createdBy: me.uid || null
      };
      try{
        await FS.addDoc(FS.collection(db,"incoming"), base);
        ok++;
      }catch(e){
        fail++;
      }
    }

    if(dupSet.size){
      toast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${ok} ÙˆØ§Ø±Ø¯. ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${dupSet.size} Ø¨Ø³Ø¨Ø¨ ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯.`, true);
    }else{
      toast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${ok} ÙˆØ§Ø±Ø¯.`, true);
    }
    if(fail){
      toast(`ØªÙ†Ø¨ÙŠÙ‡: ØªØ¹Ø°Ø± Ø­ÙØ¸ ${fail} ØµÙ/ØµÙÙˆÙ (ØªØ­Ù‚Ù‚ Ù…Ù† Firestore Rules).`);
    }
    await loadIncoming();
  }

  btnImportExcel?.addEventListener("click", ()=>{
    excelFile.value = "";
    excelFile.click();
  });

  excelFile?.addEventListener("change", async ()=>{
    const file = excelFile.files?.[0];
    if(!file) return;
    if(!/\.(xlsx|xls)$/i.test(file.name)){
      toast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§ÙƒØ³Ù„ (.xlsx Ø£Ùˆ .xls).");
      return;
    }
    await importIncomingFromExcel(file);
  });
  // ===== End Excel Import =====


  async function incomingNumberExists(number, excludeId=null){
    const n = (number||"").toString().trim();
    if(!n) return false;
    try{
      const qy = FS.query(FS.collection(db,"incoming"), FS.where("number","==",n), FS.limit(5));
      const snaps = await FS.getDocs(qy);
      if(snaps.empty) return false;
      if(!excludeId) return true;
      return snaps.docs.some(d => d.id !== excludeId);
    }catch(e){
      // If rules deny reads, fall back to loaded list (best effort)
      if(excludeId){
        return (all||[]).some(x => (x.number||"").toString().trim()===n && x.id !== excludeId);
      }
      return (all||[]).some(x => (x.number||"").toString().trim()===n);
    }
  }


  btnSave.addEventListener("click", async ()=>{
    const number = fNumber.value.trim();
    const date = fDate.value;
    const subject = fSubject.value.trim();
    const fromOrg = fFrom.value.trim();
    const sender = fSender.value.trim();
    const to = fTo.value;
    const notes = fNotes.value.trim();

    if(!number || !date || !subject){
      toast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹.");
      return;
    }

    // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯
    if(await incomingNumberExists(number, editingId)){
      toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸: Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„.");
      return;
    }

    const base = { number, date, subject, fromOrg, sender, to, notes, updatedAt: FS.serverTimestamp() };

    try{
      if(editingId){
        await FS.updateDoc(FS.doc(db,"incoming",editingId), base);
        toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.", true);
      }else{
        const me = window.__ME__ || {};
        await FS.addDoc(FS.collection(db,"incoming"), { ...base, createdAt: FS.serverTimestamp(), createdBy: me.uid || null });
        toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ§Ø±Ø¯.", true);
      }
      closeModal();
      await loadIncoming();
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸. Ø±Ø§Ø¬Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Firestore Rules.");
    }
  });

  btnDelete.addEventListener("click", async ()=>{
    if(window.__ME__?.role!=="admin"){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø­Ø°Ù Ø¥Ù„Ø§ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…."); return; }
    if(!editingId) return;
    if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙˆØ§Ø±Ø¯ØŸ")) return;
    // Ù…Ù†Ø¹ Ø­Ø°Ù Ø§Ù„ÙˆØ§Ø±Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù„ÙŠÙ‡ Ø£ÙŠ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©
    try{
      const fuCol = FS.collection(db, "incoming", editingId, "followups");
      const fuQ = FS.query(fuCol, FS.limit(1));
      const fuSnap = await FS.getDocs(fuQ);
      if(!fuSnap.empty){
        toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ÙˆØ§Ø±Ø¯ Ù„ÙˆØ¬ÙˆØ¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„ÙŠÙ‡.");
        return;
      }
    }catch(e){
      // ÙÙŠ Ø­Ø§Ù„Ø© ØªØ¹Ø°Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ Ù†Ù…Ù†Ø¹ Ø§Ù„Ø­Ø°Ù Ø­ÙØ§Ø¸Ù‹Ø§ Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ÙˆØ§Ø±Ø¯ Ù„ÙˆØ¬ÙˆØ¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„ÙŠÙ‡.");
      return;
    }

    try{
      await FS.deleteDoc(FS.doc(db,"incoming",editingId));
      toast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ§Ø±Ø¯.", true);
      closeModal();
      await loadIncoming();
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù.");
    }
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    setTimeout(loadIncoming, 500);
  });
</script>

</body>
</html>
