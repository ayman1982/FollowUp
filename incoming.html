<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุงููุงุฑุฏ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ"></div>
        <div>
          <h1>ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ</h1>
          <div class="sub">ูุธุงู ูุชุงุจุนุฉ ุงููุงุฑุฏ ูุงูุตุงุฏุฑ (Firebase + Netlify)</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">โ</span>
        <span class="role" id="whoRole">โ</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html" class="active">๐ฅ ุงููุงุฑุฏ</a>
        <a href="followup.html">๐งพ ุงููุชุงุจุนุฉ</a>
        <a href="search.html">๐ ุงูุจุญุซ</a>
        <a href="admin.html" id="adminLink">๐ก๏ธ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</a>
      </div>
    </aside>
    <main class="main">

      <div class="kpis">
        <div class="kpi"><div class="n" id="kTotal">0</div><div class="t">ุฅุฌูุงูู ุงููุงุฑุฏ</div></div>
        <div class="kpi"><div class="n" id="kThisWeek">0</div><div class="t">ุขุฎุฑ 7 ุฃูุงู</div></div>
        <div class="kpi"><div class="n" id="kToLegal">0</div><div class="t">ูุญูู ููุฅุฏุงุฑุฉ ุงููุงููููุฉ</div></div>
        <div class="kpi"><div class="n" id="kToMinister">0</div><div class="t">ูุญูู ูููุชุจ ูุนุงูู ุงููุฒูุฑ</div></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>ุงููุงุฑุฏ</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-muted" type="button" id="btnRefresh">โบ ุชุญุฏูุซ</button>
            <button class="btn btn-primary" type="button" id="btnAdd">โ ุฅุถุงูุฉ ูุงุฑุฏ</button>
          </div>
        </div>

        <div class="bd">
          <div class="grid">
            <div class="field full">
              <label>ุจุญุซ ุณุฑูุน</label>
              <input id="q" placeholder="ุฑูู ุงููุงุฑุฏ / ุงูููุถูุน / ุงูุฌูุฉ / ุงูุฑุงุณู / ุงูุชุญููู ุฅูู">
            </div>
          </div>

          <div class="tablewrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>ุฑูู ุงููุงุฑุฏ</th>
                  <th>ุชุงุฑูุฎ ุงููุฑูุฏ</th>
                  <th>ุงูููุถูุน</th>
                  <th>ุงูุฌูุฉ ุงููุงุฑุฏ ูููุง</th>
                  <th>ุงูุฑุงุณู</th>
                  <th>ุงูุชุญููู ุฅูู</th>
                  <th>ููุงุญุธุงุช</th>
                  <th>ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal" id="modal">
        <div class="panel card">
          <div class="hd">
            <h2 id="modalTitle">ุฅุถุงูุฉ/ุชุนุฏูู ูุงุฑุฏ</h2>
            <button class="btn btn-secondary" id="btnClose" type="button">ุฅุบูุงู</button>
          </div>
          <div class="bd">
            <div class="grid">
              <div class="field">
                <label>ุฑูู ุงููุงุฑุฏ</label>
                <input id="fNumber" placeholder="332301">
              </div>
              <div class="field">
                <label>ุชุงุฑูุฎ ุงููุฑูุฏ</label>
                <input id="fDate" type="date">
              </div>
              <div class="field">
                <label>ุงูุชุญููู ุฅูู</label>
                <select id="fTo">
                  <option>ุงูุฅุฏุงุฑุฉ ุงููุงููููุฉ</option>
                  <option>ููุชุจ ูุนุงูู ุงููุฒูุฑ</option>
                  <option>ุงูุฅุฏุงุฑุฉ ุงููููุฉ</option>
                  <option>ุฅุฏุงุฑุฉ ุงููุชุงุจุนุฉ</option>
                  <option>โ</option>
                </select>
              </div>
              <div class="field full">
                <label>ุงูููุถูุน</label>
                <input id="fSubject" placeholder="ุนููุงู ุงูููุถูุน">
              </div>
              <div class="field">
                <label>ุงูุฌูุฉ ุงููุงุฑุฏ ูููุง</label>
                <input id="fFrom" placeholder="ูุซุงู: ูุฌูุณ ุงููุฒุฑุงุก">
              </div>
              <div class="field">
                <label>ุงูุฑุงุณู</label>
                <input id="fSender" placeholder="ุงุณู ุงูุฑุงุณู">
              </div>
              <div class="field full">
                <label>ููุงุญุธุงุช</label>
                <textarea id="fNotes" placeholder="ููุงุญุธุงุช..."></textarea>
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" id="btnSave" type="button">ุญูุธ</button>
              <button class="btn btn-danger" id="btnDelete" type="button" style="display:none;">ุญุฐู</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
  <div class="footer">ยฉ ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ - ูุณุฎุฉ Firebase ููุนุฑุถ ูุงูุชุดุบูู</div>
<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const logout = qs("btnLogout");
  logout?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href = "index.html";
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("ุงูุญุณุงุจ ููุฏ ุงููุฑุงุฌุนุฉ ุฃู ููููู.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "ูุณุชุฎุฏู";
    qs("whoRole").textContent = (me.role==="admin") ? "ูุฏูุฑ ูุธุงู" : "ูุณุชุฎุฏู";
    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";
    window.__ME__ = { uid: user.uid, ...me };
  });
</script>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";

  const rowsEl = qs("rows");
  const qEl = qs("q");
  const btnAdd = qs("btnAdd");
  const btnRefresh = qs("btnRefresh");

  const modal = qs("modal");
  const modalTitle = qs("modalTitle");
  const btnClose = qs("btnClose");
  const btnSave = qs("btnSave");
  const btnDelete = qs("btnDelete");

  const fNumber = qs("fNumber");
  const fDate = qs("fDate");
  const fSubject = qs("fSubject");
  const fFrom = qs("fFrom");
  const fSender = qs("fSender");
  const fTo = qs("fTo");
  const fNotes = qs("fNotes");

  let all = [];
  let editingId = null;

  function openModal(item){
    modal.style.display = "block";
    if(item){
      editingId = item.id;
      modalTitle.textContent = "ุชุนุฏูู ูุงุฑุฏ";
      fNumber.value = item.number || "";
      fDate.value = item.date || "";
      fSubject.value = item.subject || "";
      fFrom.value = item.fromOrg || "";
      fSender.value = item.sender || "";
      fTo.value = item.to || "โ";
      fNotes.value = item.notes || "";
      btnDelete.style.display = "";
    }else{
      editingId = null;
      modalTitle.textContent = "ุฅุถุงูุฉ ูุงุฑุฏ";
      fNumber.value = "";
      fDate.value = "";
      fSubject.value = "";
      fFrom.value = "";
      fSender.value = "";
      fTo.value = "โ";
      fNotes.value = "";
      btnDelete.style.display = "none";
    }
  }
  function closeModal(){ modal.style.display = "none"; }

  function computeKPIs(list){
    qs("kTotal").textContent = list.length;
    const now = new Date();
    const seven = new Date(now.getTime() - 7*24*60*60*1000);
    qs("kThisWeek").textContent = list.filter(x => x.date && new Date(x.date) >= seven).length;
    qs("kToLegal").textContent = list.filter(x => x.to === "ุงูุฅุฏุงุฑุฉ ุงููุงููููุฉ").length;
    qs("kToMinister").textContent = list.filter(x => x.to === "ููุชุจ ูุนุงูู ุงููุฒูุฑ").length;
  }

  function render(){
    const q = (qEl.value||"").trim().toLowerCase();
    const list = q ? all.filter(x =>
      [x.number,x.date,x.subject,x.fromOrg,x.sender,x.to,x.notes].some(v => (v||"").toString().toLowerCase().includes(q))
    ) : all;

    computeKPIs(all);

    rowsEl.innerHTML = list.map(x=>`
      <tr>
        <td><b>${esc(x.number)}</b></td>
        <td>${esc(x.date)}</td>
        <td>${esc(x.subject)}</td>
        <td>${esc(x.fromOrg)}</td>
        <td>${esc(x.sender)}</td>
        <td>${esc(x.to)}</td>
        <td>${esc(x.notes)}</td>
        <td style="white-space:nowrap;">
          <button class="btn btn-muted" data-edit="${esc(x.id)}" type="button">ุชุนุฏูู</button>
          <button class="btn btn-secondary" data-follow="${esc(x.id)}" type="button">ูุชุงุจุนุฉ</button>
        </td>
      </tr>
    `).join("");

    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const item = all.find(z=>z.id===id);
        openModal(item);
      });
    });
    document.querySelectorAll("[data-follow]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-follow");
        sessionStorage.setItem("selectedIncomingId", id);
        location.href = "followup.html";
      });
    });
  }

  async function loadIncoming(){
    const qy = FS.query(FS.collection(db,"incoming"), FS.orderBy("createdAt","desc"), FS.limit(200));
    const snaps = await FS.getDocs(qy);
    all = snaps.docs.map(d => ({ id:d.id, ...d.data() }));
    render();
  }

  btnAdd.addEventListener("click", ()=> openModal(null));
  btnClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
  btnRefresh.addEventListener("click", loadIncoming);
  qEl.addEventListener("input", render);

  btnSave.addEventListener("click", async ()=>{
    const number = fNumber.value.trim();
    const date = fDate.value;
    const subject = fSubject.value.trim();
    const fromOrg = fFrom.value.trim();
    const sender = fSender.value.trim();
    const to = fTo.value;
    const notes = fNotes.value.trim();

    if(!number || !date || !subject){
      toast("ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุงุฑุฏ ูุชุงุฑูุฎ ุงููุฑูุฏ ูุงูููุถูุน.");
      return;
    }

    const base = { number, date, subject, fromOrg, sender, to, notes, updatedAt: FS.serverTimestamp() };

    try{
      if(editingId){
        await FS.updateDoc(FS.doc(db,"incoming",editingId), base);
        toast("ุชู ุญูุธ ุงูุชุนุฏูู.", true);
      }else{
        const me = window.__ME__ || {};
        await FS.addDoc(FS.collection(db,"incoming"), { ...base, createdAt: FS.serverTimestamp(), createdBy: me.uid || null });
        toast("ุชู ุฅุถุงูุฉ ุงููุงุฑุฏ.", true);
      }
      closeModal();
      await loadIncoming();
    }catch(e){
      toast("ุชุนุฐุฑ ุงูุญูุธ. ุฑุงุฌุน ุตูุงุญูุงุช Firestore Rules.");
    }
  });

  btnDelete.addEventListener("click", async ()=>{
    if(!editingId) return;
    if(!confirm("ุชุฃููุฏ ุญุฐู ุงููุงุฑุฏุ")) return;
    try{
      await FS.deleteDoc(FS.doc(db,"incoming",editingId));
      toast("ุชู ุญุฐู ุงููุงุฑุฏ.", true);
      closeModal();
      await loadIncoming();
    }catch(e){
      toast("ุชุนุฐุฑ ุงูุญุฐู.");
    }
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    setTimeout(loadIncoming, 500);
  });
</script>

</body>
</html>
