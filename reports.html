<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©"></div>
        <div>
          <h1>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</h1>
          <div class="sub">Ø§Ù„Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ø´Ø¦ÙˆÙ† Ù…ÙƒØªØ¨ Ø§Ù„ÙˆØ²ÙŠØ±</div>
          <div class="sub2">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ§Ø¯Ø± ÙˆØ§Ù„ÙˆØ§Ø±Ø¯</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">â€”</span>
        <span class="role" id="whoRole">â€”</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</a>
        <a href="lookups.html" id="lookupsLink">ğŸ·ï¸ Ø§Ù„Ø¬Ù‡Ø§Øª (Lookups)</a>
        <a href="followup.html">ğŸ§¾ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</a>
        <a href="search.html" class="active">ğŸ” Ø§Ù„Ø¨Ø­Ø«</a>
        <a href="admin.html" id="adminLink" style="display:none">ğŸ›¡ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
        <a href="backup.html" id="backupLink" style="display:none">ğŸ—„ï¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</a>
      </div>
    </aside>
    
<main class="main">
  <div class="card">
    <div class="card-header">
      <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
      <div class="actions">
        <button class="btn" id="btnRun" type="button">ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn btn-secondary" id="btnExcel" type="button">ØªØµØ¯ÙŠØ± Excel</button>
        <button class="btn btn-secondary" id="btnPdf" type="button">ØªØµØ¯ÙŠØ± PDF</button>
      </div>
    </div>

    <div class="grid-2" style="gap:12px; margin-top:10px">
      <div>
        <label class="lbl">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
        <select class="inp" id="repType">
          <option value="incoming">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆØ§Ø±Ø¯</option>
          <option value="outgoing">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ§Ø¯Ø±</option>
          <option value="followups">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª</option>
          <option value="summary">ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ø¹ (Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)</option>
        </select>
      </div>

      <div>
        <label class="lbl">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <div class="row" style="gap:8px">
          <input class="inp" id="dateFrom" type="date" />
          <input class="inp" id="dateTo" type="date" />
        </div>
      </div>

      <div>
        <label class="lbl">Ø±Ù‚Ù… (ÙˆØ§Ø±Ø¯/ØµØ§Ø¯Ø±)</label>
        <input class="inp" id="numFilter" placeholder="Ù…Ø«Ø§Ù„: 123" />
      </div>

      <div>
        <label class="lbl">Ø¨Ø­Ø« Ù†ØµÙŠ (Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹/Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„Ù…Ø±Ø³Ù„/Ø§Ù„ØªØ­ÙˆÙŠÙ„)</label>
        <input class="inp" id="textFilter" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«..." />
      </div>

      <div>
        <label class="lbl">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø±Ø¯</label>
        <select class="inp" id="statusFilter">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="open">Ù…ÙØªÙˆØ­</option>
          <option value="closed">Ù…ØºÙ„Ù‚</option>
        </select>
      </div>

      <div>
        <label class="lbl">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†ØªØ§Ø¦Ø¬</label>
        <select class="inp" id="limitRows">
          <option value="200">200</option>
          <option value="500">500</option>
          <option value="1000">1000</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <div class="note" id="repNote">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ø¹ Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¨ØªØµÙÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ø«Ù… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ PDF Ø£Ùˆ Excel.</div>

    <div class="hr"></div>

    <div style="overflow:auto">
      <table class="tbl" id="repTable">
        <thead id="repHead"></thead>
        <tbody id="repBody"></tbody>
      </table>
    </div>
  </div>
</main>

  </div>
  <div class="footer">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2026 - ÙˆØ­Ø¯Ø© Ø§Ø¨Ø­Ø§Ø« ÙˆØªØ·ÙˆÙŠØ± ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const repType = qs("repType");
  const dateFrom = qs("dateFrom");
  const dateTo = qs("dateTo");
  const numFilter = qs("numFilter");
  const textFilter = qs("textFilter");
  const statusFilter = qs("statusFilter");
  const limitRows = qs("limitRows");

  const btnRun = qs("btnRun");
  const btnExcel = qs("btnExcel");
  const btnPdf = qs("btnPdf");

  const repHead = qs("repHead");
  const repBody = qs("repBody");
  const repNote = qs("repNote");

  let currentCols = [];
  let currentRows = [];

  function setWho(me){
    const whoName = qs("whoName");
    const whoRole = qs("whoRole");
    if(whoName) whoName.textContent = me.name || me.email || "Ù…Ø³ØªØ®Ø¯Ù…";
    if(whoRole) whoRole.textContent = (me.role==="admin") ? "Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…" : "Ù…Ø³ØªØ®Ø¯Ù…";

    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";

    const backupLink = qs("backupLink");
    if(backupLink) backupLink.style.display = (me.role==="admin") ? "" : "none";
    const lookupsLink = qs("lookupsLink");
    if(lookupsLink) lookupsLink.style.display = (me.role==="admin" || me.role==="followup_manager") ? "" : "none";
    const reportsLink = qs("reportsLink");
    if(reportsLink) reportsLink.style.display = ""; // Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹
  }

  function toDate(ts){
    if(!ts) return null;
    if(typeof ts === "object" && ts.seconds) return new Date(ts.seconds*1000);
    if(typeof ts === "string") {
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d;
    }
    return null;
  }

  function dateInRange(d, fromStr, toStr){
    if(!d) return false;
    const from = fromStr ? new Date(fromStr + "T00:00:00") : null;
    const to = toStr ? new Date(toStr + "T23:59:59") : null;
    if(from && d < from) return false;
    if(to && d > to) return false;
    return true;
  }

  function includesText(obj, q){
    if(!q) return true;
    const s = JSON.stringify(obj || "").toLowerCase();
    return s.includes(q.toLowerCase());
  }

  function renderTable(cols, rows){
    currentCols = cols;
    currentRows = rows;

    repHead.innerHTML = `<tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr>`;
    repBody.innerHTML = rows.map(r=>{
      return `<tr>${cols.map(c=>`<td>${(r[c] ?? "")}</td>`).join("")}</tr>`;
    }).join("");

    repNote.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${rows.length}`;
  }

  async function loadIncoming(limit){
    const snap = await FS.getDocs(FS.query(FS.collection(db,"incoming"), FS.limit(limit)));
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function loadOutgoing(limit){
    const snap = await FS.getDocs(FS.query(FS.collection(db,"outgoing"), FS.limit(limit)));
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function loadFollowups(limit){
    const incSnap = await FS.getDocs(FS.query(FS.collection(db,"incoming"), FS.limit(limit)));
    const out = [];
    for(const inc of incSnap.docs){
      const inId = inc.id;
      const incData = inc.data() || {};
      const inNumber = incData.number || "";
      const fuSnap = await FS.getDocs(FS.collection(db,"incoming",inId,"followups"));
      for(const fu of fuSnap.docs){
        out.push({
          incomingId: inId,
          incomingNumber: inNumber,
          incomingDate: incData.date || "",
          followupId: fu.id,
          ...fu.data()
        });
      }
    }
    return out;
  }

  function exportExcel(){
    if(!currentRows.length){
      toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
      return;
    }
    const ws = XLSX.utils.json_to_sheet(currentRows, { header: currentCols });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "report");
    XLSX.writeFile(wb, `report_${repType.value}_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  async function exportPdf(){
    if(!currentRows.length){
      toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
      return;
    }

    const title = `ØªÙ‚Ø±ÙŠØ±: ${repType.options[repType.selectedIndex].text}`;

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø¥Ù„Ù‰ Base64 Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    let logoDataUrl = "";
    try{
      const res = await fetch("./assets/logo.png", { cache: "no-store" });
      const blob = await res.blob();
      logoDataUrl = await new Promise((resolve)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(r.result);
        r.readAsDataURL(blob);
      });
    }catch(e){
      logoDataUrl = "";
    }

    const style = `
      <style>
        @page { size: A4 landscape; margin: 0; }
        body { margin:0; direction: rtl; text-align: right; font-family: 'Cairo', Tahoma, Arial, sans-serif; }
        .pdf-header{
          background: linear-gradient(180deg, #0b3b7a 0%, #0a336a 100%);
          color:#fff;
          padding: 14mm 14mm 10mm 14mm;
          display:flex;
          align-items:center;
          justify-content: space-between;
        }
        .pdf-header .text{ flex: 1; padding-right: 8mm; }
        .pdf-header .t1{ font-size: 20px; font-weight: 800; line-height: 1.1; }
        .pdf-header .t2{ font-size: 13px; font-weight: 600; opacity: .95; margin-top: 4px; }
        .pdf-header .t3{ font-size: 15px; font-weight: 800; margin-top: 6px; }
        .pdf-header .logo{
          width: 56px; height: 56px;
          border-radius: 10px;
          overflow:hidden;
          display:flex; align-items:center; justify-content:center;
        }
        .pdf-header img{ width: 100%; height: 100%; object-fit: contain; display:block; }
        .content { padding: 10mm 14mm 12mm 14mm; }
        h1 { font-size: 16px; margin: 0 0 10px 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #bbb; padding: 6px 8px; vertical-align: top; word-wrap: break-word; font-size: 11px; }
        th { background: #e9eef5; font-weight: 700; text-align:right; }
        td { text-align:right; }
        .meta{ margin-bottom:8px; font-size:12px; color:#111; }
      </style>
    `;

    const headHtml = `<tr>${currentCols.map(c=>`<th>${c}</th>`).join("")}</tr>`;
    const bodyHtml = currentRows.map(r=>{
      return `<tr>${currentCols.map(c=>`<td>${String(r[c] ?? "")}</td>`).join("")}</tr>`;
    }).join("");

    const headerHtml = `
      <div class="pdf-header">
        <div class="text">
          <div class="t1">ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</div>
          <div class="t2">Ø§Ù„Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ø´Ø¦ÙˆÙ† Ù…ÙƒØªØ¨ Ø§Ù„ÙˆØ²ÙŠØ±</div>
          <div class="t3">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ§Ø¯Ø± ÙˆØ§Ù„ÙˆØ§Ø±Ø¯</div>
        </div>
        <div class="logo">${logoDataUrl ? `<img src="${logoDataUrl}" alt="logo" />` : ""}</div>
      </div>
    `;

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(`<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  ${style}
  <title>${title}</title>
</head>
<body>
  ${headerHtml}
  <div class="content">
    <h1>${title}</h1>
    <div class="meta">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${currentRows.length}</div>
    <table>
      <thead>${headHtml}</thead>
      <tbody>${bodyHtml}</tbody>
    </table>
  </div>
</body>
</html>`);
    w.document.close();

    w.onload = () => {
      setTimeout(()=>{ w.focus(); w.print(); }, 200);
    };
  }

  async function runReport(){
    repBody.innerHTML = "";
    repHead.innerHTML = "";
    repNote.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

    const limit = parseInt(limitRows.value || "200", 10);
    const df = dateFrom.value;
    const dt = dateTo.value;
    const nf = (numFilter.value || "").trim();
    const tf = (textFilter.value || "").trim();
    const st = statusFilter.value;

    if(repType.value === "summary"){
      const inc = await loadIncoming(limit);
      const out = await loadOutgoing(limit);

      const today = new Date();
      const pad=n=>String(n).padStart(2,"0");
      const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

      const incomingToday = inc.filter(x => (x.date || "").startsWith(todayStr)).length;

      const closed = inc.filter(x => x.closed === true || x.status==="closed").length;
      const open = inc.length - closed;

      const cols = ["Ø§Ù„Ø¨Ù†Ø¯","Ø§Ù„Ù‚ÙŠÙ…Ø©"];
      const rows = [
        {"Ø§Ù„Ø¨Ù†Ø¯":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯ (Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯)","Ø§Ù„Ù‚ÙŠÙ…Ø©": inc.length},
        {"Ø§Ù„Ø¨Ù†Ø¯":"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§Ø¯Ø± (Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯)","Ø§Ù„Ù‚ÙŠÙ…Ø©": out.length},
        {"Ø§Ù„Ø¨Ù†Ø¯":"Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…","Ø§Ù„Ù‚ÙŠÙ…Ø©": incomingToday},
        {"Ø§Ù„Ø¨Ù†Ø¯":"Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ÙØªÙˆØ­","Ø§Ù„Ù‚ÙŠÙ…Ø©": open},
        {"Ø§Ù„Ø¨Ù†Ø¯":"Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ØºÙ„Ù‚","Ø§Ù„Ù‚ÙŠÙ…Ø©": closed},
      ];
      renderTable(cols, rows);
      return;
    }

    if(repType.value === "incoming"){
      let inc = await loadIncoming(limit);
      inc = inc.filter(x=>{
        const d = toDate(x.date) || toDate(x.createdAt);
        const okDate = (df||dt) ? dateInRange(d, df, dt) : true;
        const okNum = nf ? String(x.number||"") === nf : true;
        const okText = tf ? (includesText({subject:x.subject, fromOrg:x.fromOrg, to:x.to, sender:x.sender}, tf)) : true;
        const okStatus = st ? (st==="closed" ? (x.closed===true || x.status==="closed") : !(x.closed===true || x.status==="closed")) : true;
        return okDate && okNum && okText && okStatus;
      });

      const cols = ["Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯","ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ§Ø±Ø¯","Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§","Ø§Ù„Ù…Ø±Ø³Ù„","Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰","Ø§Ù„Ø­Ø§Ù„Ø©"];
      const rows = inc.map(x=>({
        "Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯": x.number||"",
        "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ§Ø±Ø¯": x.date||"",
        "Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹": x.subject||"",
        "Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§": x.fromOrg||"",
        "Ø§Ù„Ù…Ø±Ø³Ù„": x.sender||"",
        "Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰": x.to||"",
        "Ø§Ù„Ø­Ø§Ù„Ø©": (x.closed===true || x.status==="closed") ? "Ù…ØºÙ„Ù‚" : "Ù…ÙØªÙˆØ­"
      }));
      renderTable(cols, rows);
      return;
    }

    if(repType.value === "outgoing"){
      let out = await loadOutgoing(limit);
      out = out.filter(x=>{
        const d = toDate(x.exportDate) || toDate(x.createdAt);
        const okDate = (df||dt) ? dateInRange(d, df, dt) : true;
        const okNum = nf ? String(x.number||"") === nf : true;
        const okText = tf ? (includesText({subject:x.subject, to:x.to, recipient:x.recipient, fromOrg:x.fromOrg}, tf)) : true;
        return okDate && okNum && okText;
      });

      const cols = ["Ø±Ù‚Ù… Ø§Ù„ØµØ§Ø¯Ø±","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±","Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰","Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§","Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡","Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø±Ù‚Ù… ÙˆØ§Ø±Ø¯ Ù…Ø±ØªØ¨Ø·"];
      const rows = out.map(x=>({
        "Ø±Ù‚Ù… Ø§Ù„ØµØ§Ø¯Ø±": x.number||"",
        "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±": x.exportDate||"",
        "Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰": x.to||"",
        "Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹": x.subject||"",
        "Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§": x.fromOrg||"",
        "Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡": x.recipient||"",
        "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": x.notes||"",
        "Ø±Ù‚Ù… ÙˆØ§Ø±Ø¯ Ù…Ø±ØªØ¨Ø·": x.incomingNumber || x.incomingId || ""
      }));
      renderTable(cols, rows);
      return;
    }

    if(repType.value === "followups"){
      let fu = await loadFollowups(limit);

      fu = fu.filter(x=>{
        const d = toDate(x.ts) || toDate(x.createdAt);
        const okDate = (df||dt) ? dateInRange(d, df, dt) : true;
        const okNum = nf ? (String(x.incomingNumber||"") === nf) : true;
        const okText = tf ? (includesText({type:x.type, details:x.details, to:x.to, byName:x.byName}, tf)) : true;
        return okDate && okNum && okText;
      });

      const cols = ["Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯","Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡","Ø§Ù„ØªÙØ§ØµÙŠÙ„","Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰","Ø¨ÙˆØ§Ø³Ø·Ø©","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"];
      const rows = fu.map(x=>({
        "Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯": x.incomingNumber || "",
        "Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡": x.type||"",
        "Ø§Ù„ØªÙØ§ØµÙŠÙ„": x.details||"",
        "Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰": x.to||"",
        "Ø¨ÙˆØ§Ø³Ø·Ø©": x.byName||"",
        "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡": (toDate(x.ts) ? toDate(x.ts).toLocaleString("ar-EG") : "")
      }));
      renderTable(cols, rows);
      return;
    }

    renderTable([""], []);
  }

  if(btnRun) btnRun.addEventListener("click", runReport);
  if(btnExcel) btnExcel.addEventListener("click", exportExcel);
  if(btnPdf) btnPdf.addEventListener("click", exportPdf);

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ùˆ Ù…ÙˆÙ‚ÙˆÙ.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    setWho(me);
    window.__ME__ = { uid: user.uid, email: user.email, role: me.role, status: me.status, name: me.name };
    repNote.textContent = "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø«Ù… Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.";
  });
</script>


<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";

  const sRows = qs("sRows");
  let all = [];
  let selectedId = null;

  function renderRows(list){
    sRows.innerHTML = list.map(x=>`
      <tr>
        <td><b>${esc(x.number)}</b></td>
        <td>${esc(x.date)}</td>
        <td>${esc(x.subject)}</td>
        <td>${esc(x.fromOrg)}</td>
        <td>${esc(x.to)}</td>
        <td><button class="btn btn-muted" data-open="${esc(x.id)}" type="button">Ø¹Ø±Ø¶</button></td>
      </tr>
    `).join("");

    document.querySelectorAll("[data-open]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-open");
        openDetails(id);
      });
    });
  }

  async function loadAll(){
    const qy = FS.query(FS.collection(db,"incoming"), FS.orderBy("createdAt","desc"), FS.limit(200));
    const snaps = await FS.getDocs(qy);
    all = snaps.docs.map(d=>({id:d.id, ...d.data()}));
    renderRows(all);
  }

  function applySearch(){
    const n = (qs("sNumber").value||"").trim().toLowerCase();
    const s = (qs("sSubject").value||"").trim().toLowerCase();
    const f = (qs("sFrom").value||"").trim().toLowerCase();

    const list = all.filter(x=>{
      const okN = !n || (x.number||"").toString().toLowerCase().includes(n);
      const okS = !s || (x.subject||"").toString().toLowerCase().includes(s);
      const okF = !f || (x.fromOrg||"").toString().toLowerCase().includes(f);
      return okN && okS && okF;
    });
    renderRows(list);
  }

  function tsToText(ts){
    try{
      if(!ts) return "";
      if(typeof ts === "string") return ts;
      if(ts.toDate) return ts.toDate().toLocaleString("ar-EG");
      return "";
    }catch{ return ""; }
  }

  async function openDetails(id){
    selectedId = id;
    const snap = await FS.getDoc(FS.doc(db,"incoming",id));
    if(!snap.exists()){ toast("Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
    const x = snap.data();

    qs("detailsEmpty").style.display = "none";
    qs("detailsBox").style.display = "";

    qs("dNumber").textContent = "Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ø±Ø¯: " + (x.number||"â€”");
    qs("dDate").textContent = "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯: " + (x.date||"â€”");
    qs("dFrom").textContent = "Ø§Ù„Ø¬Ù‡Ø©: " + (x.fromOrg||"â€”");

    qs("dSubject").value = x.subject||"";
    qs("dSender").value = x.sender||"";
    qs("dTo").value = x.to||"";
    qs("dNotes").value = x.notes||"";

    const qy = FS.query(FS.collection(db,"incoming",id,"followups"), FS.orderBy("ts","desc"), FS.limit(100));
    const snaps = await FS.getDocs(qy);
    const list = snaps.docs.map(d=>({id:d.id, ...d.data()}));

    qs("dFollowRows").innerHTML = list.map(a=>`
      <tr>
        <td>${esc(tsToText(a.ts))}</td>
        <td><span class="badge blue">${esc(a.type||"")}</span></td>
        <td>${esc(a.details||"")}</td>
        <td>${esc(a.to||"")}</td>
        <td>${esc(a.byName||"")}</td>
      </tr>
    `).join("");
  }

  qs("btnSearch").addEventListener("click", applySearch);
  qs("btnClear").addEventListener("click", ()=>{
    qs("sNumber").value=""; qs("sSubject").value=""; qs("sFrom").value="";
    renderRows(all);
  });

  qs("btnOpenFollow").addEventListener("click", ()=>{
    if(!selectedId) return;
    sessionStorage.setItem("selectedIncomingId", selectedId);
    location.href = "followup.html";
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    setTimeout(loadAll, 500);
  });
</script>


  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</body>
</html>
