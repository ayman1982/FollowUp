<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุงููุชุงุจุนุฉ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ"></div>
        <div>
          <h1>ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ</h1>
          <div class="sub">ูุธุงู ูุชุงุจุนุฉ ุงููุงุฑุฏ ูุงูุตุงุฏุฑ (Firebase + Netlify)</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">โ</span>
        <span class="role" id="whoRole">โ</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html">๐ฅ ุงููุงุฑุฏ</a>
        <a href="followup.html" class="active">๐งพ ุงููุชุงุจุนุฉ</a>
        <a href="search.html">๐ ุงูุจุญุซ</a>
        <a href="admin.html" id="adminLink">๐ก๏ธ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</a>
      </div>
    </aside>
    <main class="main">

<div class="card">
  <div class="hd">
    <h2>ุงููุชุงุจุนุฉ</h2>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn btn-secondary" href="incoming.html">ุฑุฌูุน ูููุงุฑุฏ</a>
      <a class="btn btn-secondary" href="search.html">ุงูุจุญุซ</a>
    </div>
  </div>
  <div class="bd">
    <div class="pills" style="margin-bottom:12px;">
      <span class="pill" id="pNumber">ุฑูู ุงููุงุฑุฏ: โ</span>
      <span class="pill" id="pFrom">ุงูุฌูุฉ: โ</span>
      <span class="pill" id="pTo">ูุญูู ุฅูู: โ</span>
    </div>

    <div class="card">
      <div class="hd"><h2 style="font-size:14px;">ุจูุงูุงุช ุงูููุถูุน</h2></div>
      <div class="bd">
        <div class="grid">
          <div class="field full">
            <label>ุงูููุถูุน</label>
            <input id="vSubject" readonly>
          </div>
          <div class="field half">
            <label>ุชุงุฑูุฎ ุงููุฑูุฏ</label>
            <input id="vDate" readonly>
          </div>
          <div class="field half">
            <label>ุงูุฑุงุณู</label>
            <input id="vSender" readonly>
          </div>
          <div class="field full">
            <label>ููุงุญุธุงุช</label>
            <textarea id="vNotes" readonly></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <div class="hd"><h2 style="font-size:14px;">ุฅุถุงูุฉ ุฅุฌุฑุงุก ูุชุงุจุนุฉ</h2></div>
      <div class="bd">
        <div class="grid">
          <div class="field half">
            <label>ููุน ุงูุฅุฌุฑุงุก</label>
            <select id="fType">
              <option>ุฑุฏ</option>
              <option>ุชุญููู</option>
              <option>ุชุนุฏูู</option>
              <option>ุชุฐููุฑ</option>
            </select>
          </div>
          <div class="field half">
            <label>ููุฌู ุฅูู / ุฌูุฉ ุงูุชุญููู</label>
            <input id="fTo" placeholder="ุงูุฌูุฉ/ุงููุณุคูู">
          </div>
          <div class="field full">
            <label>ุชูุงุตูู ุงูุฅุฌุฑุงุก</label>
            <textarea id="fDetails" placeholder="ุชูุงุตูู ุงููุชุงุจุนุฉ..."></textarea>
          </div>
          <div class="field full">
            <button class="btn btn-primary" id="btnAddFollow" type="button">ุญูุธ ุงูุฅุฌุฑุงุก</button>
          </div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <div class="hd"><h2 style="font-size:14px;">ุณุฌู ุงููุชุงุจุนุฉ</h2></div>
      <div class="bd">
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ/ุงูููุช</th>
                <th>ุงูุฅุฌุฑุงุก</th>
                <th>ุงูุชูุงุตูู</th>
                <th>ููุฌู ุฅูู</th>
                <th>ุจูุงุณุทุฉ</th>
              </tr>
            </thead>
            <tbody id="fRows"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

    </main>
  </div>
  <div class="footer">ยฉ ูุฒุงุฑุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชุฌุงุฑุฉ ุงูุฎุงุฑุฌูุฉ - ูุณุฎุฉ Firebase ููุนุฑุถ ูุงูุชุดุบูู</div>
<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const logout = qs("btnLogout");
  logout?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href = "index.html";
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("ุงูุญุณุงุจ ููุฏ ุงููุฑุงุฌุนุฉ ุฃู ููููู.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "ูุณุชุฎุฏู";
    qs("whoRole").textContent = (me.role==="admin") ? "ูุฏูุฑ ูุธุงู" : "ูุณุชุฎุฏู";
    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";
    window.__ME__ = { uid: user.uid, ...me };
  });
</script>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";

  const incomingId = sessionStorage.getItem("selectedIncomingId") || new URL(location.href).searchParams.get("id");
  const fRows = qs("fRows");

  async function loadIncoming(){
    if(!incomingId){
      toast("ุงุฎุชุฑ ููุถูุน ูู ุตูุญุฉ ุงููุงุฑุฏ ุฃููุงู.");
      location.href = "incoming.html";
      return;
    }
    const snap = await FS.getDoc(FS.doc(db,"incoming",incomingId));
    if(!snap.exists()){
      toast("ุงูููุถูุน ุบูุฑ ููุฌูุฏ.");
      location.href = "incoming.html";
      return;
    }
    const x = snap.data();
    qs("pNumber").textContent = "ุฑูู ุงููุงุฑุฏ: " + (x.number || "โ");
    qs("pFrom").textContent = "ุงูุฌูุฉ: " + (x.fromOrg || "โ");
    qs("pTo").textContent = "ูุญูู ุฅูู: " + (x.to || "โ");

    qs("vSubject").value = x.subject || "";
    qs("vDate").value = x.date || "";
    qs("vSender").value = x.sender || "";
    qs("vNotes").value = x.notes || "";
  }

  function tsToText(ts){
    try{
      if(!ts) return "";
      if(typeof ts === "string") return ts;
      if(ts.toDate) return ts.toDate().toLocaleString("ar-EG");
      return "";
    }catch{ return ""; }
  }

  async function loadFollowups(){
    const qy = FS.query(FS.collection(db,"incoming",incomingId,"followups"), FS.orderBy("ts","desc"), FS.limit(200));
    const snaps = await FS.getDocs(qy);
    const list = snaps.docs.map(d=>({id:d.id, ...d.data()}));
    fRows.innerHTML = list.map(a=>`
      <tr>
        <td>${esc(tsToText(a.ts))}</td>
        <td><span class="badge blue">${esc(a.type||"")}</span></td>
        <td>${esc(a.details||"")}</td>
        <td>${esc(a.to||"")}</td>
        <td>${esc(a.byName||"")}</td>
      </tr>
    `).join("");
  }

  qs("btnAddFollow").addEventListener("click", async ()=>{
    const type = qs("fType").value;
    const to = qs("fTo").value.trim();
    const details = qs("fDetails").value.trim();
    if(!details){
      toast("ูุฑุฌู ุฅุฏุฎุงู ุชูุงุตูู ุงูุฅุฌุฑุงุก.");
      return;
    }
    const me = window.__ME__ || {};
    try{
      await FS.addDoc(FS.collection(db,"incoming",incomingId,"followups"),{
        type, to, details,
        byUid: me.uid || null,
        byName: me.name || me.email || "ูุณุชุฎุฏู",
        ts: FS.serverTimestamp()
      });
      qs("fDetails").value = "";
      toast("ุชูุช ุฅุถุงูุฉ ุงููุชุงุจุนุฉ.", true);
      await loadFollowups();
    }catch(e){
      toast("ุชุนุฐุฑ ุฅุถุงูุฉ ุงููุชุงุจุนุฉ. ุชุญูู ูู Rules.");
    }
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    setTimeout(async ()=>{
      await loadIncoming();
      await loadFollowups();
    }, 500);
  });
</script>

</body>
</html>
