<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900;1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
<header class="topbar">
    <div class="inner container">
      <div class="brand">
        <div class="logo"><img src="assets/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©"></div>
        <div>
          <h1>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</h1>
          <div class="sub">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„ØµØ§Ø¯Ø± (Firebase + Netlify)</div>
        </div>
      </div>
      <div class="userbox">
        <span id="whoName">â€”</span>
        <span class="role" id="whoRole">â€”</span>
        <button class="btn btn-secondary" id="btnLogout" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>
  <div class="container shell">
<aside class="sidebar">
      <div class="nav">
        <a href="incoming.html">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</a>
        <a href="lookups.html" id="lookupsLink">ğŸ·ï¸ Ø§Ù„Ø¬Ù‡Ø§Øª (Lookups)</a>
        <a href="followup.html">ğŸ§¾ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</a>
        <a href="search.html">ğŸ” Ø§Ù„Ø¨Ø­Ø«</a>
        <a href="admin.html" class="active" id="adminLink">ğŸ›¡ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
      </div>
    </aside>
    <main class="main">

<div class="card">
  <div class="hd">
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)</h2>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btn-muted" id="btnReloadUsers" type="button">â†º ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>
  <div class="bd">
    <div class="notice">
      ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±: <b>Ù‚Ø¨ÙˆÙ„</b> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ (Pending) Ø£Ùˆ <b>Ø¥ÙŠÙ‚Ø§Ù</b> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.
    </div>

    <div class="tablewrap" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="usersRows"></tbody>
      </table>
    </div>
</div>

    </main>
  </div>
  <div class="footer">Â© ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© - Ù†Ø³Ø®Ø© Firebase Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ´ØºÙŠÙ„</div>
<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, toast, setActiveNav } from "./assets/ui.js";

  setActiveNav();

  const logout = qs("btnLogout");
  logout?.addEventListener("click", async ()=>{
    await AUTH.signOut(auth);
    location.href = "index.html";
  });

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="index.html"; return; }

    const snap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!snap.exists()){
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }
    const me = snap.data();
    if(me.status !== "active"){
      toast("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ùˆ Ù…ÙˆÙ‚ÙˆÙ.");
      await AUTH.signOut(auth);
      location.href="index.html";
      return;
    }

    qs("whoName").textContent = me.name || me.email || "Ù…Ø³ØªØ®Ø¯Ù…";
    qs("whoRole").textContent = (me.role==="admin") ? "Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…" : "Ù…Ø³ØªØ®Ø¯Ù…";
    const adminLink = qs("adminLink");
    if(adminLink) adminLink.style.display = (me.role==="admin") ? "" : "none";
    window.__ME__ = { uid: user.uid, ...me };
  });
</script>

<script type="module">
  import { auth, db, AUTH, FS } from "./assets/firebase.js";
  import { qs, esc, toast } from "./assets/ui.js";

  const rows = qs("usersRows");
  const btnReload = qs("btnReloadUsers");

  function badgeRole(role){
    return role==="admin" ? '<span class="badge blue">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</span>' : '<span class="badge">Ù…Ø³ØªØ®Ø¯Ù…</span>';
  }
  function badgeStatus(s){
    if(s==="active") return '<span class="badge green">Ù…ÙØ¹Ù„</span>';
    if(s==="pending") return '<span class="badge">Ù…Ø¹Ù„Ù‘Ù‚</span>';
    return '<span class="badge red">Ù…ÙˆÙ‚ÙˆÙ</span>';
  }
  }

  async function loadUsers(){
    rows.innerHTML = "";
    const qy = FS.query(FS.collection(db,"users"), FS.orderBy("createdAt","desc"), FS.limit(100));
    const snaps = await FS.getDocs(qy);

    snaps.forEach(s=>{
      const u = s.data();
      rows.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${esc(u.name||"-")}</td>
          <td>${esc(u.email||"-")}</td>
          <td>${badgeRole(u.role||"user")}</td>
          <td>${badgeStatus(u.status||"pending")}</td>
          <td style="white-space:nowrap;">
            <button class="btn btn-primary" data-act="approve" data-id="${s.id}" type="button">Ù‚Ø¨ÙˆÙ„</button>
            <button class="btn btn-secondary" data-act="block" data-id="${s.id}" type="button">Ø¥ÙŠÙ‚Ø§Ù</button>
          </td>
        </tr>
      `);
    });

    document.querySelectorAll("[data-act]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-act");
        try{
          await FS.updateDoc(FS.doc(db,"users",id), { status: act==="approve" ? "active" : "blocked" });
          toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.", true);
          await loadUsers();
        }catch(e){
          toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ø±Ø§Ø¬Ø¹ Rules).");
        }
      });
    });
  }

  btnReload.addEventListener("click", loadUsers);

  AUTH.onAuthStateChanged(auth, async (user)=>{
    if(!user) return;


    const meSnap = await FS.getDoc(FS.doc(db,"users",user.uid));
    if(!meSnap.exists()){ location.href="index.html"; return; }
    const me = meSnap.data();
    if(me.role!=="admin" || me.status!=="active"){
      toast("ØºÙŠØ± Ù…ØµØ±Ø­. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ§Ø±Ø¯.");
      location.href="incoming.html";
      return;
    }
    await loadUsers();
  });
</script>

</body>
</html>
